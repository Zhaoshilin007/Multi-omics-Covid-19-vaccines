---
title: "differential analysis on omics data across timepoints"
author: "Shilin"
date: "2022-10-10"
output: html_document
---
#Package library
```{r} 
library(gtools)
library(pls)
library(sgof)
library(data.table)
library(dplyr)
library(ggpubr)
library(tibble)
library(tidyverse)
library(Biobase)
library(BiocParallel)
library(sva)
#library(bladderbatch)
#library(snpStats)
library(data.table)
library("ggplot2")
library("gridExtra")
library("edgeR")
library("UpSetR")
library(data.table)
library(openxlsx)
library(ggrepel)
PLSDA_test <- function(mat, label) {
  X <- as.matrix(mat)
  Y <- as.numeric(label)
  plsda <- pls::plsr(Y~X,explvar=TRUE)
  #print(plsda)
  vip<-data.frame(calcVIP(plsda,ncomp = 3))
  names(vip)<-"VIP"
  vip$Lipidon<-rownames(vip)
  return(vip)
}
setGeneric("calcVIP",function(x,ncomp,...) standardGeneric("calcVIP"))
setMethod("calcVIP", signature(), function(x,ncomp,...){
  b <- c(x$loadings)[1:ncomp]
  TT <- x$scores[,1:ncomp,drop=FALSE]
  SS <- b^2 * colSums(TT^2)
  W <- x$loading.weights[,1:ncomp,drop=FALSE]
  Wnorm2 <- colSums(W^2)
  SSW <- sweep(W^2,2,SS/Wnorm2, "*")
  vips <- sqrt(nrow(SSW) * apply(SSW,1,cumsum) / cumsum(SS))
  if(ncomp >1){
    vip.mat <- as.matrix(t(vips))
  }else{
    vip.mat <- as.matrix(vips)
  }
  return(vip.mat[,ncomp])}
)

```
#Load data
```{r}
load("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/1_cleaned_data/df_omics.RData")
library(readxl)
df_outcome <- read_excel("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/df.outcome.xlsx")

df_outcome_3rd <- read_excel("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/Raw_data/outcome.xlsx")

# df_meta_overall<-read.csv("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/meta_after_combat.csv")
# 
# df_meta_overall<-
#   df.outcome %>% select(Age,Gender,"Subject_id") %>% dplyr::rename(id="Subject_id") %>%
#   merge(df_meta_overall %>% select(-c("Batch_Name",  "Batch" )),by="id")
# 
# df_lip_overall<-read.csv("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/lipid_after_combat.csv")
# 
# df_metabolomic_raw<-
#   read_xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Profile_Metabolomics.xlsx",sheet = "Meta_Batch01") %>%
#   dplyr::rename(HMDB_ID=Batch01_HMDB.ID,Metabolites=Batch01_Name) %>%
#   select(HMDB_ID,Metabolites,Batch01_Super.class) %>%
#   merge(read_xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Profile_Metabolomics.xlsx",sheet = "Meta_Batch02") %>%
#   dplyr::rename(HMDB_ID=Batch02_HMDB.ID,Metabolites=Batch02_Name) %>%
#   select(HMDB_ID,Metabolites),by="HMDB_ID") %>%
#   merge(read_xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Profile_Metabolomics.xlsx",sheet = "Meta_Batch03") %>%
#   dplyr::rename(HMDB_ID=Batch03_HMDB.ID,Metabolites=Batch03_Name) %>%
#   select(HMDB_ID,Metabolites),by="HMDB_ID") %>%
#   select(HMDB_ID,Metabolites.x,Batch01_Super.class) %>%
#   dplyr::rename(Metabolites=Metabolites.x,Class=Batch01_Super.class)
# #write.xlsx(df_metabolomic_raw,"~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Annotation.Met.xlsx")

```
#Omics in BNT
##Lipidomics 
###Mixed model
```{r}
df_lip_overall<-read.csv("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/lipid_after_combat.csv") %>%
  merge(df_outcome %>% dplyr::select(Subject_id,Age, Gender), by.x="id",by.y="Subject_id")

df_lip_overall_raw<-
  read.xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Profile_Lipid.xlsx",sheet="Lipid_Batch01") %>%
  merge(read.xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Profile_Lipid.xlsx",sheet="Lipid_Batch02"),by="LipidIon") %>%
  merge(read.xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Profile_Lipid.xlsx",sheet="Lipid_Batch03"),by="LipidIon") %>%
  dplyr::select(-c(Grade,Grade.y,Grade.x,"Class.y","Class.x"))

#Lipdomics data
# 创建一个包含两个数据集的列表，分别对应 "B" 和 "S" 疫苗组
data_by_vaccine <- list()
marker_names<-names(df_lip_overall)[-c(1:5,184:185)]
addq <- function(x) paste0("`", x, "`")
# 遍历每个疫苗组
for (vaccine_group in c("B", "S")) {
  # 根据疫苗组筛选数据
  df_vaccine <- df_lip_overall %>% 
    filter(vaccine==vaccine_group) %>% 
    filter(time!="QA") %>% 
    filter(time!="QC") 
  names(df_vaccine)[5]<-"group"
  # 将 "group" 列的标签重新定义为 "M0", "M1", "M6"
  df_vaccine$group <- factor(df_vaccine$group,
                             labels = c("M0", "M1", "M6"),
                             levels = c("PRE", "M1", "M6"))
  
  # 创建一个用于存储结果的列表
  result_lme <- list()
  
  # 循环遍历每个 marker 列
  for (i in seq_along(marker_names)) {
    marker <- marker_names[i]
    
    # 创建模型公式，其中 marker 是你当前处理的 marker 列
    formula_baseline_m1 <- as.formula(paste0(marker, "~ group + Age +Gender"))
    print(formula_baseline_m1)
    # 使用 lm4 包拟合线性混合模型
    model_baseline_m1 <- nlme::lme(formula_baseline_m1,control = lmeControl(opt = "optim"), random = ~1 | id, data = df_vaccine,na.action =na.omit )
    sum_mod <- summary(model_baseline_m1)
    sum_mod_dt <- data.frame(sum_mod$tTable)
    sum_mod_dt$Marker <- marker
    sum_mod_dt$Var <- rownames(sum_mod_dt)
    result_lme[[marker]] <- sum_mod_dt
  }
  # 将结果添加到 data_by_vaccine 列表中
  data_by_vaccine[[vaccine_group]] <- result_lme
  result_lme_dt <- do.call("rbind", result_lme)
  names(result_lme_dt)[5] <- "pval"
  # Remove intercept
  result_lme_dt <- result_lme_dt[result_lme_dt$Var != "(Intercept)",]
  result_lme_dt <- result_lme_dt[result_lme_dt$Var %in% c("groupM1","groupM6"),]
  
  result_lme_dt$p_adj <- p.adjust(result_lme_dt$pval, method = "BH")
  result_lme_dt <- result_lme_dt[,c("Value","Marker","Var","pval","p_adj" )]
  result_lme_dt <- na.omit(result_lme_dt)
  dt_w <- reshape(result_lme_dt, idvar = "Marker", timevar = "Var", direction = "wide")
  #dt_w <- dt_w[,mixedsort(names(dt_w))]
  
  #dt_w<-dt_w %>% merge(df_metabolomic_raw %>% rename(Marker=HMDB_ID),by="Marker")
  # 保存结果到 Excel 文件
  library(openxlsx)
  dt_w$Marker_new[order(dt_w$Marker)]<-df_lip_overall_raw$LipidIon[order(df_lip_overall_raw$LipidIon)]
  rownames(dt_w) <- dt_w$Marker
  dt_w<-
    dt_w %>%
    merge(df_lip_overall_raw %>% dplyr::rename(Marker_new=LipidIon) %>% dplyr::select(Class,Marker_new),by="Marker_new")
  # 将结果保存到不同的 Excel 文件中
  # file_name <- paste("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Lipidomics/LMM_", vaccine_group, ".xlsx", sep = "")
  # write.xlsx(dt_w, file = file_name)
}

#Significant marker at M1
marker.sig<-dt_w %>% filter(p_adj.groupM1<0.1) %>% pull(Marker)
test<-df_vaccine [,which(names(df_vaccine) %in% c(marker.sig,"id","group"))]

test.plot<-
  test %>% 
  pivot_longer(cols = "LPC.20.4." :"ChE.18.3.") %>% 
  mutate(group=factor(group,labels=c("6m p.v.","1m p.v.","Pre-vaccination"),levels=c("M6","M1","M0"))) %>%
  merge(dt_w %>% select(Marker,"p_adj.groupM6",Marker_new,Class) %>% dplyr::rename(name=Marker),by="name") 

# 汇总数据，决定哪些feature需要星号
summary_data <- 
  data.frame(Marker_new=unique(test.plot$Marker_new)) %>%
  merge(test.plot %>% dplyr::select(Marker_new,p_adj.groupM6,Class),by="Marker_new") %>%
  distinct(Marker_new,.keep_all = TRUE) %>%
  mutate(Persistent=case_when(p_adj.groupM6>=0.1 ~ "*",
                              TRUE ~ "")) %>%
  mutate(Persistent=as.factor(Persistent))

ggplot(test.plot, aes(x = Marker_new, y = value )) +
  geom_boxplot(
    aes(fill = group),
    position = position_dodge(0.9) 
  ) +
  geom_text(data = summary_data, aes(x=Marker_new,y=7,label = Persistent,colour = "red")) +
    scale_color_identity(guide = "none") +
  scale_fill_manual(values = c("#116da9", "#d1a86b","#1d9770"))+
  coord_flip()+ 
  facet_grid( "Class" , scales = "free", space = "free") +
  labs(fill="Timepoint",y="Log2 (Abundance)")+
  theme_classic()+
  theme(strip.text.y = element_text(angle = 0),
        axis.title.y=element_blank())

ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Lipidomics/Boxplot_SNV.pdf", 
       height = 8,
       width = 12)

#Significant marker at M1 for BNT162b2 vaccine
dt_w_BNT<-read_xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Lipidomics/LMM_B.xlsx") 

marker.sig<-dt_w_BNT %>% filter(p_adj.groupM1<0.1) %>% pull(Marker)

test<-df_lip_overall %>% 
  filter(vaccine=="B") %>% 
  filter(time!="QA")  %>%
  dplyr::rename(group=time) 
test<-test [,which(names(test) %in% c(marker.sig,"id","group"))]

test.plot<-
  test %>% 
  pivot_longer(cols = "LPC.14.0..rep.":"Co.Q10." ) %>% 
  mutate(group=factor(group,labels=c("6m p.v.","1m p.v.","Pre-vaccination"),levels=c("M6","M1","PRE"))) %>%
  merge(dt_w_BNT %>% select(Marker,"p_adj.groupM6",Marker_new,Class) %>% dplyr::rename(name=Marker),by="name") 

# 汇总数据，决定哪些feature需要星号
summary_data <- 
  data.frame(Marker_new=unique(test.plot$Marker_new)) %>%
  merge(test.plot %>% dplyr::select(Marker_new,p_adj.groupM6,Class),by="Marker_new") %>%
  distinct(Marker_new,.keep_all = TRUE) %>%
  mutate(Persistent=case_when(p_adj.groupM6>=0.1 ~ "*",
                              TRUE ~ "")) %>%
  mutate(Persistent=as.factor(Persistent))

ggplot(test.plot, aes(x = Marker_new, y = value )) +
  geom_boxplot(
    aes(fill = group),
    position = position_dodge(0.9) 
  ) +
  geom_text(data = summary_data, aes(x=Marker_new,y=7,label = Persistent,colour = "red"))  +
  scale_color_identity(guide = "none") +
  scale_fill_manual(values = c("#116da9", "#d1a86b","#1d9770"))+
  coord_flip()+ 
  labs(fill="Timepoint",y="Log2 (Abundance)")+
  facet_grid( "Class" , scales = "free", space = "free") +
  theme_classic()+
  theme(strip.text.y = element_text(angle = 0),
        axis.title.y=element_blank())

ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Lipidomics/Boxplot_BNT_new.pdf", 
       height = 12,
       width = 12)

library(CTDext)
Enrich_Met<-list()
for (vaccine_type in c("B","S")){
  df_met_module_kegg<-
    read_xlsx(paste0("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/LMM_",vaccine_type,".xlsx"))%>% 
    filter(p_adj.groupM1<0.1) 
  
  df_KEGG<-fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/KEGG_pathway_database/kegg_tgo_pathway/tgo_KEGG_com.tsv')
  com_ano <- df_KEGG %>% select(KEGG.ID,pathway_id,pathway_name)
  gene_select_up <- c(df_met_module_kegg$Marker[grepl("C",df_met_module_kegg$Marker)],data.HMDBtoKEGG(df_met_module_kegg$Marker[grepl("HMDB",df_met_module_kegg$Marker)]))
  #KEGG 富集分析
  #默认以所有注释到 KEGG 的基因为背景集，也可通过 universe 参数指定其中的一个子集作为背景集
  #默认以 p<0.05 为标准，Benjamini 方法校正 p 值，q 值阈值 0.2
  #默认输出 top500 富集结果
  
  
  kegg_rich_fdr_up <- clusterProfiler::enricher(gene = gene_select_up$KEGG,
                                                TERM2GENE = com_ano[,c('pathway_id', 'KEGG.ID')], 
                                                TERM2NAME = com_ano[,c('pathway_id', 'pathway_name')],
                                                pvalueCutoff = 0.1, 
                                                pAdjustMethod = 'fdr', 
                                                qvalueCutoff = 0.1, 
                                                maxGSSize = 10000)
  
  
  Enrich_Met[[vaccine_type]]<-kegg_rich_fdr_up
}

df.kegg.enrich<-
  bind_rows(Enrich_Met$B@result %>% arrange(-Count)  %>% mutate(group="BNT162b2"),
            Enrich_Met$S@result %>% arrange(-Count) %>% mutate(group="CoronaVac")) %>%
  filter(Count>=2) %>%
  mutate(y.color=
           case_when(group=="BNT162b2" ~ "#64b4e4",
                     group=="CoronaVac" ~ "#FF6F00FF")) %>%
  mutate(group=as.factor(group))

write.csv(df.kegg.enrich,"~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/enrichment.csv")

ggplot(df.kegg.enrich,aes(x=Count,y=reorder(Description,Count)))+
  geom_bar(aes(fill=p.adjust),stat = "identity",alpha=0.7,width = 0.8) + 
  scale_fill_distiller(palette = "PiYG")+
  facet_grid(~df.kegg.enrich$group)+
  geom_text(aes(x=Count+0.3,y=Description,label=Count))+
  theme_test()+
  xlim(c(0,max(df.kegg.enrich$Count)+1))+
  theme(legend.position = 'right')+
  theme(axis.text.y = element_text(face = 'plain',size=10))+
  ylab("Pathways")

ggsave(file = paste0("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/Enrichment_plot.pdf"),height=10,width=13)
```

###Veen plot for both metabolomics and vaccination
```{r}

res_diff_lip_bnt<-
  read.xlsx(paste("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Lipidomics/LMM_", "B", ".xlsx", sep = "")) %>%
  mutate(M1_M0_direction=case_when(Value.groupM1>0 ~ "Upregulated", TRUE ~ "Downregulated"),
         M6_M0_direction=case_when(Value.groupM6>0 ~ "Upregulated", TRUE ~ "Downregulated"))

res_diff_lip_snv<-
  read.xlsx(paste("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Lipidomics/LMM_", "S", ".xlsx", sep = "")) %>%
  mutate(M1_M0_direction=case_when(Value.groupM1>0 ~ "Upregulated", TRUE ~ "Downregulated"),
         M6_M0_direction=case_when(Value.groupM6>0 ~ "Upregulated", TRUE ~ "Downregulated"))

# Summarize counts
bind_rows(
  res_diff_lip_bnt %>% filter(p_adj.groupM1 < 0.1) %>% count(M1_M0_direction) %>% mutate(group = "Baseline Vs 1m p.v."),
  res_diff_lip_bnt %>% filter(p_adj.groupM6 < 0.1) %>% count(M6_M0_direction) %>% mutate(group = "Baseline Vs 6m p.v.")
) %>% rename(direction = starts_with("M"))

res_diff_lip_bnt %>% 
  filter(p_adj.groupM1 < 0.1 & p_adj.groupM6 < 0.1) %>%
  dplyr::group_by(M1_M0_direction, M6_M0_direction) %>%
  dplyr::summarize(count = n())


# Summarize counts
bind_rows(
  res_diff_lip_snv %>% filter(p_adj.groupM1 < 0.1) %>% count(M1_M0_direction) %>% mutate(group = "Baseline Vs 1m p.v."),
  res_diff_lip_snv %>% filter(p_adj.groupM6 < 0.1) %>% count(M6_M0_direction) %>% mutate(group = "Baseline Vs 6m p.v.")
) %>% rename(direction = starts_with("M"))

res_diff_lip_snv %>% 
  filter(p_adj.groupM1 < 0.1 & p_adj.groupM6 < 0.1) %>%
  dplyr::group_by(M1_M0_direction, M6_M0_direction) %>%
  dplyr::summarize(count = n())

```
###Univarite analyses
```{r} 
df_raw_lip_bnt_diff<-df_lip_overall_QC_correct %>% t() %>% as.data.frame()
df_raw_lip_bnt_diff$group<-"M0"
df_raw_lip_bnt_diff[grepl("M1",rownames(df_raw_lip_bnt_diff)),"group"]<-"M1"
df_raw_lip_bnt_diff$group<-as.factor(df_raw_lip_bnt_diff$group)

# Log2 (FC)
cn <- paste("FC_", "M1", "_", "M0", sep = "")

G1 <- df_raw_lip_bnt_diff[which(df_raw_lip_bnt_diff$group=="M0"), ]
G2 <- df_raw_lip_bnt_diff[which(df_raw_lip_bnt_diff$group=="M1"), ]

substr(rownames(G1) ,9,13)== substr(rownames(G2) ,9,13)
overlapp.id<-intersect(substr(rownames(G1) ,9,13),substr(rownames(G2) ,9,13))
rownames(G1)<-substr(rownames(G1) ,9,13) 
rownames(G2)<-substr(rownames(G2) ,9,13)
G1<-G1[overlapp.id,-ncol(G1)] %>% mutate_if(is.character,as.numeric)
G2<-G2[overlapp.id,-ncol(G2)] %>% mutate_if(is.character,as.numeric)
fc.mat = G2/G1;
fc.all <- colMeans(fc.mat);

test_results_lip_time<-
  cbind(test_results_lip_time,fc.all)

##wilcox.test
test_results_lip_time$p.wilcox <- apply(df_correct_lip[, -ncol(df_correct_lip)], 2,
                                       function(x) unlist(wilcox.test(as.numeric(x) ~ df_correct_lip$group, data = df_correct_lip,paired = TRUE)[3]))

test_results_met_time<-
  test_results_met_time %>%
  arrange(p.wilcox) %>%
  mutate(p.ad.fdr=p.adjust(p.wilcox, method = "fdr")) %>% # adjust p value from wilcox.test using BH method
  mutate(p.ad.sgof=sgof::SGoF(p.wilcox)$Adjusted.pvalues)  # adjust p value from wilcox.test using SGoF method
met.vip<-PLSDA_test(df_correct_lip[,-ncol(df_correct_lip)],
                    label=df_correct_lip$group)
names(met.vip)[2]<-"LipidIon"

test_results_met_time_bnt<-
  merge(met.vip,test_results_met_time,by="LipidIon") %>%
  mutate(Match_ID=sub("\\__.*","",LipidIon)) %>%
  merge(read.xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/KEGG_ID.xlsx"),by="Match_ID")

df_correct_lip<-df_correct_lip_bnt
df_correct_lip$group<-"M0"
df_correct_lip[grepl("M1",rownames(df_correct_lip)),"group"]<-"M1"
df_correct_lip$group<-as.factor(df_correct_lip$group)
# U test
test_results_lip_time <- data.frame(Lipidon = colnames(df_correct_lip)[-ncol(df_correct_lip)])

# Log2 (FC)
cn <- paste("FC_", "M1", "/", "M0", sep = "")
test_results_lip_time[cn] <- apply(df_correct_lip[-ncol(df_correct_lip)], 2, 
                                   function(x) 
                                     median(as.numeric(x[which(df_correct_lip$group == "M1")]))/
                                     median(as.numeric(x[which(df_correct_lip$group == "M0")])))
test_results_lip_time$LOG2FC <- log2(abs(test_results_lip_time[,2]))

##wilcox.test
test_results_lip_time$p.wilcox <- apply(df_correct_lip[, -ncol(df_correct_lip)], 2,
                                       function(x) unlist(wilcox.test(as.numeric(x) ~ df_correct_lip$group, data = df_correct_lip,paired = TRUE)[3]))

test_results_lip_time<-
  test_results_lip_time %>%
  arrange(p.wilcox) %>%
  mutate(p.ad.fdr=p.adjust(p.wilcox, method = "fdr")) %>% # adjust p value from wilcox.test using BH method
  mutate(p.ad.sgof=sgof::SGoF(p.wilcox)$Adjusted.pvalues)  # adjust p value from wilcox.test using SGoF method

lip.vip<-PLSDA_test(df_correct_lip[,-ncol(df_correct_lip)],
                    label=df_correct_lip$group)
names(lip.vip)[2]<-"Lipidon"

test_results_lip_time_bnt<-
  merge(lip.vip,test_results_lip_time,by="Lipidon") 
nrow(test_results_lip_time_bnt %>% filter(p.ad.fdr<0.05) %>%  filter(`FC_M1/M0`>=1.2|`FC_M1/M0`<=0.8))

write.table(test_results_lip_time_bnt,"~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Lipidomics/Differential_Lipidomic_BNT.txt",sep = "\t",row.names = FALSE)
```
###Volcano plot
```{r}
##input significant features
df.lip.annotation<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Processed_data/df.lip.annotation.txt") %>%
  janitor::row_to_names(row_number = 1)

results_lip_bnt<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Lipidomics/Differential_Lipidomic_BNT.txt")

diff_results_lip_bnt_m1_vs_m0<-
  read.xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Lipidomics/LMM_B.xlsx") %>%
  dplyr::rename(Features=Marker_new) %>% filter(p_adj.groupM1<0.1) %>%
  merge(results_lip_bnt %>% dplyr::select(Lipidon,LOG2FC,"FC_M1/M0"),by.x="Features",by.y="Lipidon")%>%
  mutate(Feature_type = case_when(`FC_M1/M0` >= 1.2 & p_adj.groupM1<0.1  ~ "Up",
                               `FC_M1/M0` <= 0.85 & p_adj.groupM1<0.1~ "Down",
                               TRUE ~ "Not significant"))

dim(diff_results_lip_bnt_m1_vs_m0)
#[1] 45 12

 #%>%
  # mutate(Feature_type = case_when(`FC_M1/M0` >= 1.2 & p.wilcox<0.05  ~ "Up",
  #                             `FC_M1/M0` <= 0.85 & p.wilcox<0.05 ~ "Down",
  #                             TRUE ~ "Not significant")) %>%
  # mutate(vip_cat=case_when(VIP>1 ~ "VIP > 1",
  #                          TRUE ~ "VIP ≤ 1")) %>%
  #  mutate(p_ad_cat=case_when(p.ad.sgof<0.05 ~ "Significant",
  #                          TRUE ~ "Not significant")) %>%
  # mutate_at(vars(c ("vip_cat","p_ad_cat")),as.factor) %>%
  # dplyr::rename(Features=Lipidon) %>%
  # merge(df.lip.annotation %>% dplyr::select(Features,Class),by="Features")

sig_il_lip<-
  results_lip_bnt %>%
  filter(Feature_type %in% c("Up", "Down")) %>%
  distinct(Features,.keep_all = TRUE)


#ChE dMePE LPC LPI PC PE PI PS NS=#CCCDCB
# #2F7DB9, #4E51A1 #43B14C, #914D9A, #F2EB2A, #F49E45, #E982B1, #65BFA3 
# Check gene_type categories ---------------------------------------------------
results_lip_bnt %>%
  distinct(Feature_type) %>%
  pull()  

results_lip_bnt[-which(results_lip_bnt$Class %in% unique(sig_il_lip$Class)),"Class"] <-"Not significant"
results_lip_bnt[which(results_lip_bnt$p.ad.sgof>=0.05),"Class"] <-"Not significant"
results_lip_bnt[which(results_lip_bnt$FC_High.response.Low.response>=0.85 &results_lip_bnt$FC_High.response.Low.response<=1.2),"Class"] <-"Not significant"

unique(results_lip_bnt$Class)

cols <- c("Up"="#D8404D",
          "Down"= "#6485B5",
          "Not significant" = "#CCCDCB")

# sizes <- c("VIP > 1"=5,"VIP ≤ 1"=3) 
# alphas <- c("Up" = 1, "Down" = 1, "Not significant" = 0.5)
shape<-c("Significant"=19,"Not significant"=17)

p.bnt.lip<-results_lip_bnt %>%
  ggplot(aes(x = LOG2FC,
             y = -log10(p.wilcox),
             shape=p_ad_cat)) + 
  geom_point(aes(colour = factor(Feature_type)),size=3) + 
  labs(colour = "", shape = "sgof-adjusted P value") +
  scale_shape_manual(values = shape)+
  #scale_colour_manual(values = cols,name="Metabolites Class") +
  scale_colour_manual(values = cols) +
  #scale_fill_manual(values = cols) + # Modify point colour
geom_text_repel(data = bind_rows(
    sig_il_lip %>% 
      filter(Feature_type == 'Up') %>% 
      arrange(p.wilcox,desc(abs(LOG2FC))) %>% 
      head(5),
    sig_il_lip %>% 
      filter(Feature_type == 'Down') %>% 
      arrange(p.wilcox,desc(abs(LOG2FC))) %>% 
      head(5)
  ), # Add labels last to appear as the top layer
                  aes(label = Features),
                  #family = "Times New Roman",
                  box.padding = 0.5,
                  size =3,
                  max.overlaps = getOption("ggrepel.max.overlaps", 200))+
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed", color="#C2C2C2") + 
  geom_vline(xintercept =log2(0.85),
             linetype = "dashed", color="#C2C2C2") +
  geom_vline(xintercept = log2(1.2),
             linetype = "dashed", color="#C2C2C2")+
  #scale_size_manual(values = sizes,name="VIP score") + # Modify point size
  #scale_alpha_manual(values = alphas) + # Modify point transparency
  #scale_shape_manual(values = shape, name="VIP score") +
  ggtitle("Altered Lipidomics in BNT162b2")+
  labs(x = expression("-Log"["2"]*" (Fold Change)"),
       y= expression("-Log"["10"]*" (P Value)"))+   theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(),          panel.background = element_rect(color = 'black', fill = 'transparent'),          legend.key = element_rect(fill = 'transparent')) +
       #y= expression("-Log"["10"]*" (P Value)"))+   theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(),          panel.background = element_rect(color = 'black', fill = 'transparent'),          legend.key = element_rect(fill = 'transparent')) +
  # + # Modify point size
  scale_x_continuous(breaks = c(seq(-2,2,1)),       
                     limits = c(-2,2))
p.bnt.lip
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Multi-Omics/DE_markers/m1_m0/volcano_bnt_lip.pdf",width=5,height=5)

```
###Box plot across BNT
```{r}
diff_results_lip_bnt_m1_vs_m0<-
  read.xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Lipidomics/LMM_B.xlsx") %>%
  dplyr::rename(Features=Marker_new) %>% filter(p_adj.groupM1<0.1)
names(diff_results_lip_bnt_m1_vs_m0)

# #write.table(diff_results_lip_bnt_m0,"~/shilin/Multi-omics_V2_20220922/Result/Difference analysis/ Feature list/BNT/immunogenicity/diff_results_lip_bnt_m0_immunogenicity.txt",sep="\t")

diff.box.lip.m0.immunogenicity<-
  df_lip_overall %>%
  filter(time!="QA") %>%
  select(diff_results_lip_bnt_m1_vs_m0$Marker,vaccine,time,id) %>%
  # rownames_to_column() %>%
   melt() %>% ##convert long data as input
  group_by(variable) %>% 
  mutate(median = median(value), group_max = max(value)) %>% 
  dplyr::rename(Features=variable) %>%
  mutate(vaccine=factor(vaccine,levels=c("B","S"),labels=c("BNT162b2","CoronaVac"))) %>%
  merge(diff_results_lip_bnt_m1_vs_m0, by.x="Features",by.y="Marker") %>%
  mutate(Class=factor(Class)) %>%
  #mutate(Features=factor(Features,levels=unique(Features[order(Class)]))) %>%# 调整因子顺序：
  group_by(Features) %>%
  mutate(group_number=length(unique(vaccine)))

sorted_features <- diff.box.lip.m0.immunogenicity %>%
  filter(time != "M6") %>%
  group_by(Features.y) %>%
  summarize(median_value = median(value)) %>%
  arrange(desc(median_value)) %>%
  mutate(Features.y = factor(Features.y, levels = .$Features.y))

# Merge the sorted features with the original data frame
diff.box.lip.m0.immunogenicity <- 
  diff.box.lip.m0.immunogenicity %>%
  mutate(Features.y = factor(Features.y, levels = sorted_features$Features.y)) %>%
  mutate(Class=factor(Class, 
                      levels=c("LPC" , "PC" , "SM", "FA"," ChE" ,  "Co","OAHFA" ,  "PE", "PS"),
                      labels=c("LPC" , "PC" , "SM", "FA"," ChE" ,  "Co","OAHFA" ,  "PE", "PS")))

##input raw data including the significant features, 行为variable，列为features
library(ggplot2)
library(ggpubr)
library(tidyverse)
library(latex2exp)
library(rstatix)
class_col<- c("#A6CEE4","#1F78B4","#B2E08A","#30A12C",
                  "#FEBF6E","#FF7F00","#FB9B98","#E31A20","yellow")
library(grid)


# 绘图：
p1<-ggplot(diff.box.lip.m0.immunogenicity %>% filter(time!="M6") %>% filter(vaccine=="BNT162b2"))+
  # 基础图形：
  geom_boxplot(aes(Features.y, value, fill = time),outlier.shape = 21, outlier.fill = "white")+
  facet_grid( ~ Class, scales = "free", space = "free_x") +
  # 设置颜色：
  scale_fill_manual(values = c("PRE" = "#d6503a", "M1" = "#5488ef"))+
  # 设置主题：
  theme_bw()+
    theme(
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.line = element_line(colour = "black"),
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5), # Panel border
    panel.grid.major.x = element_blank(),  # Remove vertical grid lines
    panel.grid.minor.x = element_blank(),  # Remove vertical grid lines
    panel.grid.major.y = element_line(colour = "grey80"),  # Only horizontal grid lines
    strip.background = element_rect(fill = "grey90", colour = NA), # Background color for the Class strip
    legend.justification = c(1, 1),
    strip.text.x = element_text(size = 10))+
   ylim(10, 35) +
  guides(fill=guide_legend(title="Timepoints"))+
  lab(x="Features",y="Ex")

p2<-ggplot(diff.box.lip.m0.immunogenicity %>% filter(time!="M6") %>% filter(vaccine=="BNT162b2"))+
  # 基础图形：
  geom_boxplot(aes(Features.y, value, fill = time),outlier.shape = 21, outlier.fill = "white")+
  facet_grid( ~ Class, scales = "free", space = "free_x") +
  # 设置颜色：
  scale_fill_manual(values = c("PRE" = "#d6503a", "M1" = "#5488ef"))+
  # 设置主题：
  theme_bw()+
    theme(
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.line = element_line(colour = "black"),
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5), # Panel border
    panel.grid.major.x = element_blank(),  # Remove vertical grid lines
    panel.grid.minor.x = element_blank(),  # Remove vertical grid lines
    panel.grid.major.y = element_line(colour = "grey80"),  # Only horizontal grid lines
    strip.background = element_rect(fill = "grey90", colour = NA), # Background color for the Class strip
    legend.justification = c(1, 1),
    strip.text.x = element_text(size = 10))+
   ylim(10, 35) +
  guides(fill=guide_legend(title="Timepoints"))+
  lab(x="Features",y="Ex")

#ggsave("~/Multi-omics_V2_20220922/Result/Difference analysis/ Feature list/BNT/immunogenicity/differential_immunogenicity_m0_across_vaccine.pdf",width=15,height=7)

```
##Metabolomics
###Mixed model
```{r}
# 创建一个包含两个数据集的列表，分别对应 "B" 和 "S" 疫苗组
data_by_vaccine <- list()
marker_names<-names(df_meta_overall)[-c(1:5)]
# 遍历每个疫苗组
for (vaccine_group in c("B", "S")) {
    # 根据疫苗组筛选数据
    df_vaccine <- df_meta_overall %>% 
      filter(vaccine==vaccine_group) %>% 
      filter(time!="QA") 
    names(df_vaccine)[5]<-"group"
    # 将 "group" 列的标签重新定义为 "M0", "M1", "M6"
    df_vaccine$group <- factor(df_vaccine$group,
                               labels = c("M0", "M1", "M6"),
                               levels = c("PRE", "M1", "M6"))
    
    # 创建一个用于存储结果的列表
    result_lme <- list()
    
    # 循环遍历每个 marker 列
    for (i in seq_along(marker_names)[1:2]) {
      marker <- marker_names[i]
      
      # 创建模型公式，其中 marker 是你当前处理的 marker 列
      formula_baseline_m1 <- as.formula(paste(marker, "~ group + Age +Gender"))
      print(formula_baseline_m1)
      # 使用 lm4 包拟合线性混合模型
      model_baseline_m1 <- nlme::lme(formula_baseline_m1, random = ~1 | id, data = df_vaccine)
      sum_mod <- summary(model_baseline_m1)
      sum_mod_dt <- data.frame(sum_mod$tTable)
      sum_mod_dt$Marker <- marker
      sum_mod_dt$Var <- rownames(sum_mod_dt)
      result_lme[[marker]] <- sum_mod_dt
    }
    # 将结果添加到 data_by_vaccine 列表中
    data_by_vaccine[[vaccine_group]] <- result_lme
    result_lme_dt <- do.call("rbind", result_lme)
    names(result_lme_dt)[5] <- "pval"
    # Remove intercept
    result_lme_dt <- result_lme_dt[result_lme_dt$Var != "(Intercept)",]
    result_lme_dt <- result_lme_dt[result_lme_dt$Var %in% c("groupM1","groupM6"),]
    
    result_lme_dt$p_adj <- p.adjust(result_lme_dt$pval, method = "BH")
    result_lme_dt <- result_lme_dt[,c("Value","Marker","Var","pval","p_adj" )]
    result_lme_dt <- na.omit(result_lme_dt)
    dt_w <- reshape(result_lme_dt, idvar = "Marker", timevar = "Var", direction = "wide")
    #dt_w <- dt_w[,mixedsort(names(dt_w))]
    rownames(dt_w) <- dt_w$Marker
    dt_w<-dt_w %>% merge(df_metabolomic_raw %>% rename(Marker=HMDB_ID),by="Marker")
    # 保存结果到 Excel 文件
    library(openxlsx)
  
  # 将结果保存到不同的 Excel 文件中
  file_name <- paste("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/LMM_", vaccine_group, ".xlsx", sep = "")
  write.xlsx(dt_w, file = file_name)
}

#Significant marker at M1
dt_w<-read_xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/LMM_S.xlsx")

test<-
  df_meta_overall %>% 
      filter(vaccine=="S") %>% 
      filter(time!="QA")  %>% 
  dplyr::rename(group=time) %>% 
  select(c(id,group,matches(dt_w %>% filter(p_adj.groupM1<0.1) %>% pull(Marker))))

test.plot<-
  test %>% 
  pivot_longer(cols = C10784:HMDB0014515) %>% 
  merge(df_metabolomic_raw %>% dplyr:: rename(name=HMDB_ID)) %>%
  mutate(Class=as.factor(Class)) %>%
  mutate(group=factor(group,labels=c("6m p.v.","1m p.v.","Pre-vaccination"),levels=c("M6","M1","PRE"))) %>%
  merge(dt_w %>% select(Marker,"p_adj.groupM6") %>% dplyr::rename(name=Marker),by="name") 

# 汇总数据，决定哪些feature需要星号
summary_data <- 
  data.frame(Marker=unique(test.plot$Metabolites)) %>%
  merge(test.plot %>% dplyr::select(Metabolites,p_adj.groupM6,Class),by.x="Marker",by.y="Metabolites") %>%
  distinct(Marker,.keep_all = TRUE) %>%
  mutate(Persistent=case_when(p_adj.groupM6>=0.1 ~ "*",
                              TRUE ~ "")) %>%
  mutate(Persistent=as.factor(Persistent))

ggplot(test.plot, aes(x = Metabolites, y = value )) +
  geom_boxplot(
    aes(fill = group),
    position = position_dodge(0.9) 
  ) +
  geom_text(data = summary_data, aes(x=Marker,y=7,label = Persistent,colour = "red")) +
    scale_color_identity(guide = "none") +
  scale_fill_manual(values = c("#116da9", "#d1a86b","#1d9770"))+
  coord_flip()+ 
  facet_grid( "Class" , scales = "free", space = "free") +
  labs(fill="Timepoint",y="Log2 (Abundance)")+
  theme_classic()+
  theme(strip.text.y = element_text(angle = 0),
        axis.title.y=element_blank())

ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/Boxplot_SNV.pdf", 
  height = 8,
  width = 12)

#Significant marker at M1
dt_w_BNT<-read_xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/LMM_B.xlsx") 
test<-df_meta_overall %>% 
  filter(vaccine=="B") %>% 
  filter(time!="QA")  %>%
  dplyr::rename(group=time) %>%
  select(c(id,group,matches(dt_w_BNT %>% filter(p_adj.groupM1<0.1) %>% pull(Marker))))

test.plot<-
  test %>% 
  pivot_longer(cols = C01226:HMDB0124993) %>% 
  merge(df_metabolomic_raw %>% dplyr:: rename(name=HMDB_ID)) %>%
  mutate(Class=as.factor(Class)) %>%
  mutate(group=factor(group,labels=c("6m p.v.","1m p.v.","Pre-vaccination"),levels=c("M6","M1","PRE"))) %>%
  merge(dt_w %>% select(Marker,"p_adj.groupM6") %>% dplyr::rename(name=Marker),by="name") 

# 汇总数据，决定哪些feature需要星号
summary_data <- 
  data.frame(Marker=unique(test.plot$Metabolites)) %>%
  merge(test.plot %>% dplyr::select(Metabolites,p_adj.groupM6,Class),by.x="Marker",by.y="Metabolites") %>%
  distinct(Marker,.keep_all = TRUE) %>%
  mutate(Persistent=case_when(p_adj.groupM6>=0.1 ~ "*",
                              TRUE ~ "")) %>%
  mutate(Persistent=as.factor(Persistent))

ggplot(test.plot, aes(x = Metabolites, y = value )) +
  geom_boxplot(
    aes(fill = group),
    position = position_dodge(0.9) 
  ) +
  geom_text(data = summary_data, aes(x=Marker,y=5,label = Persistent,colour = "red")) +
    scale_color_identity(guide = "none") +
  scale_fill_manual(values = c("#116da9", "#d1a86b","#1d9770"))+
  coord_flip()+ 
  facet_grid( "Class" , scales = "free", space = "free") +
  labs(fill="Timepoint",y="Log2 (Abundance)")+
  theme_classic()+
  theme(strip.text.y = element_text(angle = 0),
        axis.title.y=element_blank())

ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/Boxplot_BNT.pdf", 
       height = 10,
       width = 12)

library(CTDext)
Enrich_Met<-list()
for (vaccine_type in c("B","S")){
  df_met_module_kegg<-
    read_xlsx(paste0("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/LMM_",vaccine_type,".xlsx"))%>% 
                filter(p_adj.groupM1<0.1) 
              
              df_KEGG<-fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/KEGG_pathway_database/kegg_tgo_pathway/tgo_KEGG_com.tsv')
              com_ano <- df_KEGG %>% select(KEGG.ID,pathway_id,pathway_name)
              gene_select_up <- c(df_met_module_kegg$Marker[grepl("C",df_met_module_kegg$Marker)],data.HMDBtoKEGG(df_met_module_kegg$Marker[grepl("HMDB",df_met_module_kegg$Marker)]))
              #KEGG 富集分析
              #默认以所有注释到 KEGG 的基因为背景集，也可通过 universe 参数指定其中的一个子集作为背景集
              #默认以 p<0.05 为标准，Benjamini 方法校正 p 值，q 值阈值 0.2
              #默认输出 top500 富集结果
              
              
              kegg_rich_fdr_up <- clusterProfiler::enricher(gene = gene_select_up$KEGG,
                                                            TERM2GENE = com_ano[,c('pathway_id', 'KEGG.ID')], 
                                                            TERM2NAME = com_ano[,c('pathway_id', 'pathway_name')],
                                                            pvalueCutoff = 0.1, 
                                                            pAdjustMethod = 'fdr', 
                                                            qvalueCutoff = 0.1, 
                                                            maxGSSize = 10000)
              
              
             Enrich_Met[[vaccine_type]]<-kegg_rich_fdr_up
}

df.kegg.enrich<-
  bind_rows(Enrich_Met$B@result %>% arrange(-Count)  %>% mutate(group="BNT162b2"),
            Enrich_Met$S@result %>% arrange(-Count) %>% mutate(group="CoronaVac")) %>%
  filter(Count>=2) %>%
  mutate(y.color=
           case_when(group=="BNT162b2" ~ "#64b4e4",
                     group=="CoronaVac" ~ "#FF6F00FF")) %>%
  mutate(group=as.factor(group))

write.csv(df.kegg.enrich,"~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/enrichment.csv")

df.kegg.enrich<-read.csv("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/enrichment.csv")
df.kegg.enrich<-df.kegg.enrich %>% filter(qvalue<=0.1)
ggplot(df.kegg.enrich,aes(x=Count,y=reorder(Description,Count)))+
  geom_bar(aes(fill=qvalue),stat = "identity",alpha=0.7,width = 0.8) + 
  scale_fill_distiller(palette = "PiYG")+
  facet_grid(~df.kegg.enrich$group)+
  geom_text(aes(x=Count+0.3,y=Description,label=Count))+
  theme_test()+
  xlim(c(0,max(df.kegg.enrich$Count)+1))+
  theme(legend.position = 'right')+
  theme(axis.text.y = element_text(face = 'plain',size=10))+
  ylab("Pathways")

ggsave(file = paste0("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/Enrichment_plot_M1.pdf"),height=10,width=13)


```
###Veen plot for both metabolomics and vaccination
```{r}

res_diff_met_bnt<-
  read.xlsx(paste("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/LMM_", "B", ".xlsx", sep = "")) %>%
  mutate(M1_M0_direction=case_when(Value.groupM1>0 ~ "Upregulated", TRUE ~ "Downregulated"),
         M6_M0_direction=case_when(Value.groupM6>0 ~ "Upregulated", TRUE ~ "Downregulated"))

res_diff_met_snv<-
  read.xlsx(paste("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/LMM_", "S", ".xlsx", sep = "")) %>%
  mutate(M1_M0_direction=case_when(Value.groupM1>0 ~ "Upregulated", TRUE ~ "Downregulated"),
         M6_M0_direction=case_when(Value.groupM6>0 ~ "Upregulated", TRUE ~ "Downregulated"))

# Summarize counts
bind_rows(
  res_diff_met_bnt %>% filter(p_adj.groupM1 < 0.1) %>% count(M1_M0_direction) %>% mutate(group = "Baseline Vs 1m p.v."),
  res_diff_met_bnt %>% filter(p_adj.groupM6 < 0.1) %>% count(M6_M0_direction) %>% mutate(group = "Baseline Vs 6m p.v.")
) %>% rename(direction = starts_with("M"))

res_diff_met_bnt %>% 
  filter(p_adj.groupM1 < 0.1 & p_adj.groupM6 < 0.1) %>%
  dplyr::group_by(M1_M0_direction, M6_M0_direction) %>%
  dplyr::summarize(count = n())


# Summarize counts
bind_rows(
  res_diff_met_snv %>% filter(p_adj.groupM1 < 0.1) %>% count(M1_M0_direction) %>% mutate(group = "Baseline Vs 1m p.v."),
  res_diff_met_snv %>% filter(p_adj.groupM6 < 0.1) %>% count(M6_M0_direction) %>% mutate(group = "Baseline Vs 6m p.v.")
) %>% rename(direction = starts_with("M"))

res_diff_met_snv %>% 
  filter(p_adj.groupM1 < 0.1 & p_adj.groupM6 < 0.1) %>%
  dplyr::group_by(M1_M0_direction, M6_M0_direction) %>%
  dplyr::summarize(count = n())

```
###Specific markers
```{r}
df_metabolomic_1st<-
  read_xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Profile_Metabolomics.xlsx",sheet = "Meta_Batch01")
#Ceramide (d18:1/20:0)

bnt_id<-df.outcome %>% filter(Vaccine_type=="B") %>% pull(Subject_id)
df_metabolomic_Ceramide<-
  df_metabolomic_1st %>%
  filter(Batch01_Name=="Ceramide (d18:1/20:0)") %>%
  select(matches("PRE|M1")) %>%
  select(matches(bnt_id)) %>%
  t() %>% as.data.frame() %>%
  rownames_to_column("Subject_id") %>%
  mutate(group=substr(Subject_id,15,17),
         Subject_id=substr(Subject_id,9,13)) %>%
  mutate(group=factor(group,levels=c("PRE","M1"),labels=c("Pre-vaccination","1m p.v."))) %>%
  merge(df.outcome %>% dplyr::select(m1_cat,sVNT_M1_WT_RBD_200_times_dilution,Subject_id),by="Subject_id")

wilcox.test(log2(df_metabolomic_Ceramide$V1)~df_metabolomic_Ceramide$group,paired=TRUE)
df_metabolomic_Ceramide %>%
  filter(Subject_id!="VA292") %>%
  filter(Subject_id!="VA145") %>%
  filter(Subject_id!="VA524") %>%
  group_by(group) %>%
  summarise(mean=mean(log2(V1)))

ggplot(df_metabolomic_Ceramide, aes(x = group, y = log2(V1))) +
  geom_boxplot(
    aes(fill = group),
    position = position_dodge(0.9) 
  ) +
  #geom_text(data = summary_data, aes(x=Marker_new,y=7,label = Persistent,colour = "red")) +
  scale_color_identity(guide = "none") +
  scale_fill_manual(values = c("#116da9", "#d1a86b")) +
  labs(x = "Timepoint",y="Log2 (Abundance)",fill="Timepoint",
       title = "Ceramide, Fold Change:1.08, P value: 0.002") +
  theme_classic()+
  theme(strip.text.y = element_text(angle = 0),
        axis.title.x=element_blank())

cor.test(df_metabolomic_Ceramide %>% filter(group=="Pre-vaccination") %>% pull(V1),df_metabolomic_Ceramide %>% filter(group=="M0") %>% pull(m1_cat))
df_metabolomic_Ceramide_M0<-
  df_metabolomic_Ceramide %>% filter(group=="Pre-vaccination") %>%
  mutate(m1_cat=as.factor(m1_cat)) %>%
  mutate(logV1=log2(V1))

df_metabolomic_Ceramide_M1<-
  df_metabolomic_Ceramide %>% filter(group=="1m p.v.") %>%
  mutate(m1_cat=as.factor(m1_cat)) %>%
  mutate(logV1=log2(V1))

ggscatter(df_metabolomic_Ceramide_M1,x="sVNT_M1_WT_RBD_200_times_dilution",y="logV1",size=1,
          #color = "m1_cat", palette = c("#00AFBB", "#E7B800"),
          #label = "name", 
          add =  "reg.line",
          repel = TRUE,#避免标签重合
          cor.coef = TRUE,
          mean.point = FALSE,star.plot = FALSE)

ggscatter(df_metabolomic_Ceramide_M0,x="sVNT_M1_WT_RBD_200_times_dilution",y="logV1",size=1,
          #color = "m1_cat", palette = c("#00AFBB", "#E7B800"),
          #label = "name", 
          add =  "reg.line",
          repel = TRUE,#避免标签重合
          cor.coef = TRUE,
          mean.point = FALSE,star.plot = FALSE)

wilcox.test(log2(df_metabolomic_Ceramide_M1$V1)~df_metabolomic_Ceramide_M1$m1_cat)
ggplot(df_metabolomic_Ceramide_M1, aes(x = m1_cat, y = log2(V1))) +
  geom_boxplot(
    aes(fill = m1_cat),
    position = position_dodge(0.9) 
  ) +
  #geom_text(data = summary_data, aes(x=Marker_new,y=7,label = Persistent,colour = "red")) +
  scale_color_identity(guide = "none") +
  scale_fill_manual(values = c("#116da9", "#d1a86b")) +
  labs(x = "Timepoint",y="Log2 (Abundance)",fill="Timepoint",
       title = "Ceramide, Fold Change:1.08, P value: 0.002") +
  theme_classic()+
  theme(strip.text.y = element_text(angle = 0),
        axis.title.x=element_blank())

```

###Pathways for M6
```{r}
library(CTDext)
Enrich_Met<-list()
for (vaccine_type in c("B","S")){
  df_met_module_kegg<-
    read_xlsx(paste0("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/LMM_",vaccine_type,".xlsx"))%>% 
    filter(p_adj.groupM6<=0.1) %>%
    filter(p_adj.groupM1<=0.1) 
  
  df_KEGG<-fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/KEGG_pathway_database/kegg_tgo_pathway/tgo_KEGG_com.tsv')
  com_ano <- df_KEGG %>% select(KEGG.ID,pathway_id,pathway_name)
  gene_select_up <- c(df_met_module_kegg$Marker[grepl("C",df_met_module_kegg$Marker)],data.HMDBtoKEGG(df_met_module_kegg$Marker[grepl("HMDB",df_met_module_kegg$Marker)]))
  #KEGG 富集分析
  #默认以所有注释到 KEGG 的基因为背景集，也可通过 universe 参数指定其中的一个子集作为背景集
  #默认以 p<0.05 为标准，Benjamini 方法校正 p 值，q 值阈值 0.2
  #默认输出 top500 富集结果
  
  
  kegg_rich_fdr_up <- clusterProfiler::enricher(gene = gene_select_up$KEGG,
                                                TERM2GENE = com_ano[,c('pathway_id', 'KEGG.ID')], 
                                                TERM2NAME = com_ano[,c('pathway_id', 'pathway_name')],
                                                pvalueCutoff = 0.1, 
                                                pAdjustMethod = 'fdr', 
                                                qvalueCutoff = 0.1, 
                                                maxGSSize = 10000)
  
  
  Enrich_Met[[vaccine_type]]<-kegg_rich_fdr_up
}

df.kegg.enrich<-
  bind_rows(Enrich_Met$B@result %>% arrange(-Count)  %>% mutate(group="BNT162b2"),
            Enrich_Met$S@result %>% arrange(-Count) %>% mutate(group="CoronaVac")) %>%
  filter(Count>=2) %>%
  mutate(y.color=
           case_when(group=="BNT162b2" ~ "#64b4e4",
                     group=="CoronaVac" ~ "#FF6F00FF")) %>%
  mutate(group=as.factor(group))

write.csv(df.kegg.enrich,"~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/enrichment_M6_v2.csv")
df.kegg.enrich<-df.kegg.enrich %>% filter(qvalue<=0.1)
ggplot(df.kegg.enrich,aes(x=Count,y=reorder(Description,Count)))+
  geom_bar(aes(fill=qvalue),stat = "identity",alpha=0.7,width = 0.8) + 
  scale_fill_distiller(palette = "PiYG")+
  facet_grid(~df.kegg.enrich$group)+
  geom_text(aes(x=Count+0.3,y=Description,label=Count))+
  theme_test()+
  xlim(c(0,max(df.kegg.enrich$Count)+1))+
  theme(legend.position = 'right')+
  theme(axis.text.y = element_text(face = 'plain',size=10))+
  ylab("Pathways")

ggsave(file = paste0("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/Enrichment_plot_M6_v2.pdf"),height=10,width=13)

```
###Univariate analyses
```{r}
#selected_subjects <- df.outcome %>% filter(Vaccine_type == "B") %>% pull(Subject_id)
df_correct_met <- 
  df_meta_overall %>% 
  filter(vaccine=="B") %>% 
  filter(time!="QA") %>%
  filter(time!="M6")

names(df_correct_met)[5]<-"group"
df_correct_met$group<-as.factor(df_correct_met$group)

# df_raw_met_bnt_diff[grepl("PRE",rownames(df_raw_met_bnt_diff)),"group"]<-"M0"
# df_raw_met_bnt_diff[grepl("M1",rownames(df_raw_met_bnt_diff)),"group"]<-"M1"
# df_raw_met_bnt_diff[grepl("QC",rownames(df_raw_met_bnt_diff)),"group"]<-"QC"
# df_raw_met_bnt_diff$group<-as.factor(df_raw_met_bnt_diff$group)

# t test
test_results_met_time <- data.frame(Metabolites = colnames(df_correct_met)[-c(1:5)])

# Log2 (FC)
cn <- paste("FC_", "M1", "_", "M0", sep = "")

# G1 <- df_raw_met_bnt_diff[which(df_raw_met_bnt_diff$group=="M0"), ]
# G2 <- df_raw_met_bnt_diff[which(df_raw_met_bnt_diff$group=="M1"), ]
# substr(rownames(G1) ,9,13)== substr(rownames(G2) ,9,13)
# overlapp.id<-intersect(substr(rownames(G1) ,9,13),substr(rownames(G2) ,9,13))
# rownames(G1)<-substr(rownames(G1) ,9,13)
# rownames(G2)<-substr(rownames(G2) ,9,13)
# G1<-G1[overlapp.id,-ncol(G1)] %>% mutate_if(is.character,as.numeric)
# G2<-G2[overlapp.id,-ncol(G2)] %>% mutate_if(is.character,as.numeric)
# fc.mat = G2/G1;
# fc.all <- colMeans(fc.mat);
# summary(fc.all)
# 
# test_results_met_time<-
#   cbind(test_results_met_time,fc.all)

##wilcox.test
# U test
# Log2 (FC)
cn <- paste("LOG2FC_", "M1", "_", "M0", sep = "")
test_results_met_time[cn] <- apply(df_correct_met[-c(1:5)], 2,
                                   function(x)
                                     median(as.numeric(x[which(df_correct_met$group == "M1")]))-
                                     median(as.numeric(x[which(df_correct_met$group == "PRE")])))

test_results_met_time$p.wilcox <- 
  apply(df_correct_met[, -c(1:5)], 2, function(x) unlist(wilcox.test(as.numeric(x) ~ df_correct_met$group, data = df_correct_met ,paired = TRUE)[3]))

test_results_met_time<-
  test_results_met_time %>%
  mutate(fc.all=2^LOG2FC_M1_M0) %>%
  arrange(p.wilcox) %>%
  mutate(p.ad.fdr=p.adjust(p.wilcox, method = "fdr")) %>% # adjust p value from wilcox.test using BH method
  mutate(p.ad.sgof=sgof::SGoF(p.wilcox)$Adjusted.pvalues)  # adjust p value from wilcox.test using SGoF method

met.vip<-PLSDA_test(df_correct_met[,-c(1:5)],
                    label=df_correct_met$group)
names(met.vip)[2]<-"Metabolites"

test_results_met_time_bnt<-
  merge(met.vip,test_results_met_time,by="Metabolites") %>%
  mutate(Match_ID=sub("\\__.*","",Metabolites)) %>%
  merge(read.xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/KEGG_ID.xlsx"),by="Match_ID")

View(test_results_met_time %>% filter(p.ad.sgof<0.05) %>% filter(fc.all>=1.15|fc.all<=0.85))

write.table(test_results_met_time_bnt,"~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/Differential_Metabolomics_BNT_v1.txt",sep = "\t",row.names = FALSE)

```
###Volcano Plot
```{r}
##input significant features
df.met.annotation<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Processed_data/df.met.annotation.txt") 

results_met_bnt<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Metabolomics/Differential_Metabolomics_BNT_v1.txt") %>%
  mutate(Feature_type = case_when(fc.all >= 1.2 & p.ad.fdr<0.1  ~ "Up",
                                  fc.all <= 0.8 & p.ad.fdr<0.1 ~ "Down",
                                  TRUE ~ "Not significant")) %>%
  mutate(vip_cat=case_when(VIP>1 ~ "VIP > 1",
                           TRUE ~ "VIP ≤ 1")) %>%
  mutate(p_ad_cat=case_when(p.ad.fdr<0.1 ~ "Significant",
                           TRUE ~ "Not significant")) %>%
  mutate_at(vars("vip_cat"),as.factor) %>%
  dplyr::rename(Features=Metabolites) %>%
  merge(df.met.annotation %>% 
          mutate(Features=paste0(HMDB,"__",Batch01_Name)) %>%
          dplyr::rename(Class=Batch01_Class) %>% 
          dplyr::select(Features,Class),by="Features")

sig_il_met<-
  results_met_bnt %>%
  filter(Feature_type %in% c("Up", "Down")) %>%
  distinct(Features,.keep_all = TRUE)


#ChE dMePE LPC LPI PC PE PI PS NS=#CCCDCB
# #2F7DB9, #4E51A1 #43B14C, #914D9A, #F2EB2A, #F49E45, #E982B1, #65BFA3 
# Check gene_type categories ---------------------------------------------------
results_met_bnt %>%
  distinct(Feature_type) %>%
  pull()  

results_met_bnt[-which(results_met_bnt$Class %in% unique(sig_il_met$Class)),"Class"] <-"Not significant"
results_met_bnt[which(results_met_bnt$p.ad.fdr>=0.1),"Class"] <-"Not significant"
results_met_bnt[which(results_met_bnt$FC_High.response.Low.response>=0.85 &results_met_bnt$FC_High.response.Low.response<=1.2),"Class"] <-"Not significant"

unique(results_met_bnt$Class)

cols <- c("Up"="#D8404D",
          "Down"= "#6485B5",
          "Not significant" = "#CCCDCB")
# 
# sizes <- c("VIP > 1"=5,"VIP ≤ 1"=3) 
# alphas <- c("Up" = 1, "Down" = 1, "Not significant" = 0.5)
shape<-c("Significant"=19,"Not significant"=17)

p.bnt.met<-results_met_bnt %>%
  ggplot(aes(x = LOG2FC_M1_M0,
             y = -log10(p.ad.fdr))) + 
  geom_point(aes(colour = factor(Feature_type)),size=3) + 
  labs(colour = "", shape = "sgof-adjusted P value") +
  #scale_shape_manual(values = shape)+
  #scale_colour_manual(values = cols,name="Metabolites Class") +
  scale_colour_manual(values = cols) +
  #scale_fill_manual(values = cols) + # Modify point colour
  geom_text_repel(data = bind_rows(
    sig_il_met %>% 
      filter(Feature_type == 'Up') %>% 
      arrange(p.ad.fdr,desc(abs(LOG2FC_M1_M0))) %>% 
      head(5),
    sig_il_met %>% 
      filter(Feature_type == 'Down') %>% 
      arrange(p.ad.fdr,desc(abs(LOG2FC_M1_M0))) %>% 
      head(5)
  ), # Add labels last to appear as the top layer
                  aes(label = Features),
                  #family = "Times New Roman",
                  box.padding = 0.5,
                  size =3,
                  max.overlaps = getOption("ggrepel.max.overlaps", 5))+
  geom_hline(yintercept = -log10(0.1),
             linetype = "dashed", color="#C2C2C2") + 
  geom_vline(xintercept =log2(0.8),
             linetype = "dashed", color="#C2C2C2") +
  geom_vline(xintercept = log2(1.2),
             linetype = "dashed", color="#C2C2C2")+
  #scale_size_manual(values = sizes,name="VIP score") + # Modify point size
  #scale_alpha_manual(values = alphas) + # Modify point transparency
  #scale_shape_manual(values = shape, name="VIP score") +
  ggtitle("Altered Metabolomics in BNT162b2")+
  labs(x = expression("-Log"["2"]*" (Fold Change)"),
       y= expression("-Log"["10"]*" (P Value)"))+   theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(),          panel.background = element_rect(color = 'black', fill = 'transparent'),          legend.key = element_rect(fill = 'transparent')) +
       #y= expression("-Log"["10"]*" (P Value)"))+   theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(),          panel.background = element_rect(color = 'black', fill = 'transparent'),          legend.key = element_rect(fill = 'transparent')) +
  # + # Modify point size
  scale_x_continuous(breaks = c(seq(-2,2,1)),       
                     limits = c(-2,2))
p.bnt.met
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/volcano_bnt_met.pdf",width=15,height=13)
```
###Enrichment Bar plot combining with class
```{r}

##Divided the significant features as upregulated and downregulated
for (i in c(0.8)){
  for (j in c(1.2)){
  df.bnt.barplot.Met_up<-
  read.table("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Metabolomics_BNT.txt",header=TRUE) %>%
  filter( p.ad.sgof<0.05) %>% 
  #filter(fc.all>=j) %>%
  #match the df.meta.overall using raw dataset
  merge(fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Processed_data/df.met.annotation.txt",header=TRUE) %>%
  mutate(Metabolites=paste0(HMDB,"__",Batch01_Name)) %>%
  dplyr::select(Metabolites,Batch01_Class,Batch01_Name), by="Metabolites") %>%
  mutate(group="Metabolomics")
  
library(CTDext)
df_met_module_kegg_up<-
  df.bnt.barplot.Met_up %>%
  filter(KEGG_ID!="NA")

df_KEGG<-fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/KEGG_pathway_database/kegg_tgo_pathway/tgo_KEGG_com.tsv')
com_ano <- df_KEGG %>% select(KEGG.ID,pathway_id,pathway_name)
gene_select_up <- df_met_module_kegg_up$KEGG_ID
#KEGG 富集分析
#默认以所有注释到 KEGG 的基因为背景集，也可通过 universe 参数指定其中的一个子集作为背景集
#默认以 p<0.05 为标准，Benjamini 方法校正 p 值，q 值阈值 0.2
#默认输出 top500 富集结果

kegg_rich_fdr_up <- clusterProfiler::enricher(gene = gene_select_up,
                      TERM2GENE = com_ano[,c('pathway_id', 'KEGG.ID')], 
                      TERM2NAME = com_ano[,c('pathway_id', 'pathway_name')],
                      pvalueCutoff = 0.1, 
                      pAdjustMethod = 'fdr', 
                      qvalueCutoff = 0.1, 
                      maxGSSize = 5000)

Figure.title.ensembl<-paste0("Enrichment_plot_BNT162b2_Upregulation_",i,"_",j)

pdf(file = paste0("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/WGCNA/Metabolomics/diff/BNT/", i,"_",j,"up.pdf"),height=10,width=10)
    plot_i_j<-clusterProfiler::dotplot(kegg_rich_fdr_up, ,x="Count",showCategory=20,title=Figure.title.ensembl)
   print(plot_i_j)
    dev.off()

df.bnt.barplot.Met_down<-
  read.table("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Metabolomics_BNT.txt",header=TRUE) %>%
  filter( p.ad.sgof<0.05) %>% 
  filter(`FC_M1.M0`<=i) %>%
  #match the df.meta.overall using raw dataset
  merge(fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Processed_data/df.met.annotation.txt",header=TRUE) %>%
  mutate(Metabolites=paste0(HMDB,"__",Batch01_Name)) %>%
  dplyr::select(Metabolites,Batch01_Class,Batch01_Name), by="Metabolites") %>%
  mutate(group="Metabolomics")
  
library(CTDext)
df_met_module_kegg_down<-
  df.bnt.barplot.Met_down %>%
  filter(KEGG_ID!="NA")

df_KEGG<-fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/KEGG_pathway_database/kegg_tgo_pathway/tgo_KEGG_com.tsv')
com_ano <- df_KEGG %>% select(KEGG.ID,pathway_id,pathway_name)
gene_select_down <- df_met_module_kegg_down$KEGG_ID
#KEGG 富集分析
#默认以所有注释到 KEGG 的基因为背景集，也可通过 universe 参数指定其中的一个子集作为背景集
#默认以 p<0.05 为标准，Benjamini 方法校正 p 值，q 值阈值 0.2
#默认输出 top500 富集结果

kegg_rich_fdr_down <- clusterProfiler::enricher(gene = gene_select_down,
                      TERM2GENE = com_ano[,c('pathway_id', 'KEGG.ID')], 
                      TERM2NAME = com_ano[,c('pathway_id', 'pathway_name')],
                      pvalueCutoff = 0.1, 
                      pAdjustMethod = 'fdr', 
                      qvalueCutoff = 0.1, 
                      maxGSSize = 5000)

Figure.title.ensembl<-paste0("Enrichment_plot_BNT162b2_Downregulation_",i,"_",j)

pdf(file = paste0("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/WGCNA/Metabolomics/diff/BNT/", i,"_",j,"down.pdf"),height=10,width=10)
    plot_i_j<-clusterProfiler::dotplot(kegg_rich_fdr_down,x="Count", showCategory=20,title=Figure.title.ensembl)
   print(plot_i_j)
    dev.off()
    
  }
}

```
##Transcriptomics
###Veen plot
```{r}
res_bnt_M6_M0<-
  fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Transcriptomics/M1_M0_Limma_Adjust_M6_M0_BNT.txt') %>%
  column_to_rownames("V1") %>%
  mutate(direction=case_when(log2FoldChange>=log2(2) ~ "Upregulated",
                             log2FoldChange<=-log2(2) ~ "Downregulated",
                             TRUE ~ "None")) %>%
rename_all(~paste0("M6_M0_", .)) %>%
  filter(M6_M0_direction!="None")
  

res_bnt_M1_M0<-
  fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Transcriptomics/M1_M0_Limma_BNT.txt') %>%
  column_to_rownames("V1") %>%
  mutate(direction=case_when(log2FoldChange>=log2(1.5) ~ "Upregulated",
                             log2FoldChange<=-log2(1.5) ~ "Downregulated",
                             TRUE ~ "None")) %>%
rename_all(~paste0("M1_M0_", .))%>%
  filter(M1_M0_direction!="None")

res_snv_M6_M0<-
  fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Transcriptomics/M1_M0_Limma_Adjust_M6_M0_SNV.txt') %>%
  column_to_rownames("V1") %>%
  mutate(direction=case_when(log2FoldChange>=log2(2) ~ "Upregulated",
                             log2FoldChange<=-log2(2) ~ "Downregulated",
                             TRUE ~ "None")) %>%
rename_all(~paste0("M6_M0_", .))%>%
  filter(M6_M0_direction!="None")

res_snv_M1_M0<-
  fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Transcriptomics/M1_M0_Limma_SNV.txt') %>%
  column_to_rownames("V1") %>%
  mutate(direction=case_when(log2FoldChange>=log2(1.5) ~ "Upregulated",
                             log2FoldChange<=-log2(1.5) ~ "Downregulated",
                             TRUE ~ "None")) %>%
rename_all(~paste0("M1_M0_", .))%>%
  filter(M1_M0_direction!="None")

res_bnt_persistent<-
  res_bnt_M1_M0 %>% 
  filter(M1_M0_padj<0.05) %>%
  merge(res_bnt_M6_M0 %>% filter(M6_M0_padj<0.001), by=0)

res_snv_persistent<-
  res_snv_M1_M0 %>% 
  filter(M1_M0_padj<0.05) %>%
  merge(res_snv_M6_M0 %>% filter(M6_M0_padj<0.001), by=0)

result_rna_persistent<-
  list("BNT_persistent"=res_bnt_persistent,
       "SNV_persistent"=res_snv_persistent)
library(openxlsx)
write.xlsx(result_rna_persistent,"~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Transcriptomics/Persistent_RNA.xlsx")


x <- list(
  "Baseline Vs 1m p.v." = rownames(res_bnt_M1_M0 %>% filter(M1_M0_padj<0.05)), 
  "Baseline Vs 6m p.v." = rownames(res_bnt_M6_M0 %>% filter(M6_M0_padj<0.001) %>% filter(abs(M6_M0_log2FoldChange)>=log2(4)))
)


ggvenn(
  x, 
  fill_color = c("#0073C2FF", "#EFC000FF"),
  stroke_size = 0.5, set_name_size = 4
)+
  ggtitle("BNT162b2")


# Summarize counts
df_counts <- bind_rows(
  res_bnt_M1_M0 %>% filter(M1_M0_padj < 0.05) %>% count(M1_M0_direction) %>% mutate(group = "Baseline Vs 1m p.v."),
  res_bnt_M6_M0 %>% filter(M6_M0_padj < 0.001, abs(M6_M0_log2FoldChange) >= log2(4)) %>% count(M6_M0_direction) %>% mutate(group = "Baseline Vs 6m p.v.")
) %>% rename(direction = starts_with("M"))


```
###Vocanol plot & Differential analyses
```{r}
##Volcano plot
# c("Up"="#D8404D",
#           "Down"= "#6485B5",
#           "Not significant" = "#CCCDCB")
##ggplot2 差异火山图
library(ggplot2)

res.bnt.1<-
  fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Transcriptomics/M1_M0_Limma_BNT.txt') %>%
  column_to_rownames("V1")

res.bnt.1<-
  res.bnt.1 %>%
 mutate(p_ad_cat=case_when(padj<0.05 ~ "Significant",
                           TRUE ~ "Not significant")) %>%
mutate(sig=case_when(log2FoldChange >= log2(1.5) & padj <0.05 ~ "Up",
                     log2FoldChange <= -log2(1.5) & padj <0.05 ~ "Down",
                     TRUE ~ "Not significant"))


#输出选择的差异基因总表
res.bnt.1_select <- subset(res.bnt.1, sig %in% c('Up', 'Down'))
res.bnt.1_select$feature<-rownames(res.bnt.1_select)
#默认情况下，横轴展示 log2FoldChange，纵轴展示 -log10 转化后的 p value

shape<-c("Significant"=19,"Not significant"=17)
p.bnt.rna <- ggplot(data = res.bnt.1, 
                    aes(x = log2FoldChange, 
                        y = -log10(padj), 
                        color = sig,
                        shape=p_ad_cat)) +
  labs(colour = "Direction", shape = "adjusted P value") +
    geom_point(size = 3) +  #绘制散点图
  scale_shape_manual(values = shape)+
  scale_color_manual(values = c('#D8404D', '#CCCDCB', '#6485B5'), limits = c('Up', 'Not significant', 'Down')) +  #自定义点的颜色
  #labs(x = 'log2 Fold Change', y = '-log10 adjust p-value', title = 'M1 vs M0', color = '') +  #坐标轴标题
  theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(), #背景色、网格线、图例等主题修改
        panel.background = element_rect(color = 'black', fill = 'transparent'), 
        legend.key = element_rect(fill = 'transparent')) +
  geom_vline(xintercept = c(-log2(1.5), log2(1.5)), lty = 3, color = 'black') +  #添加阈值线
  geom_hline(yintercept = -log10(0.05), lty = 3, color = 'black') +
  guides(color = guide_legend(override.aes = list(size = 3)))+
  ggtitle("Altered Transcriptomics in BNT162b2")+
   geom_text_repel(data =  bind_rows(
    res.bnt.1_select %>% 
      filter(sig == 'Up') %>% 
      filter(log2FoldChange>=1) %>% 
      arrange(desc(abs(log2FoldChange)),padj) %>% 
      head(5),
    res.bnt.1_select %>% 
      filter(sig == 'Down') %>% 
      filter(log2FoldChange<=-1) %>% 
      arrange(desc(abs(log2FoldChange)),padj) %>% 
      head(5)
  ) %>% 
    mutate(feature=case_when(grepl("__NA__NA",feature) ~ gsub("\\..*", "", feature),
                        TRUE ~ gsub("__", "",str_extract(feature, "__(.*?)__")))), # Add labels last to appear as the top layer
                  aes(label = feature),
                  #family = "Times New Roman",
                  box.padding = 0.5,
                  size =3,
                  max.overlaps = getOption("ggrepel.max.overlaps", 600))+
  labs(x = expression("-Log"["2"]*" (Fold Change)"),
       y= expression("-Log"["10"]*" (adjusted P Value)"))+   theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(),          panel.background = element_rect(color = 'black', fill = 'transparent'),          legend.key = element_rect(fill = 'transparent')) 
p.bnt.rna
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Transcriptomics/volcano_bnt_rna.pdf",width=12,height=15)
```
#omics in SNV
##Lipidomics
```{r} 
df_correct_lip<-df_correct_lip_snv
df_correct_lip$group<-"M0"
df_correct_lip[grepl("M1",rownames(df_correct_lip)),"group"]<-"M1"
df_correct_lip$group<-as.factor(df_correct_lip$group)
fre<-as.data.frame(table(df_correct_lip$subject))
fre[which(fre$Freq=="1"),"Var1"]
df_correct_lip<-
  df_correct_lip[-which(df_correct_lip$subject %in% fre[which(fre$Freq=="1"),"Var1"]),]
# t test
test_results_lip_time <- data.frame(Lipidon = colnames(df_correct_lip)[2:718])

# Log2 (FC)
cn <- paste("FC_", "M1", "/", "M0", sep = "")
test_results_lip_time[cn] <- apply(df_correct_lip[,2:718], 2, 
                                   function(x) 
                                     median(as.numeric(x[which(df_correct_lip$group == "M1")]))/
                                     median(as.numeric(x[which(df_correct_lip$group == "M0")])))
test_results_lip_time$LOG2FC <- log2(abs(test_results_lip_time[,2]))

##wilcox.test
test_results_lip_time$p.wilcox <- apply(df_correct_lip[,2:718], 2,
                                       function(x) unlist(wilcox.test(as.numeric(x) ~ df_correct_lip$group, data = df_correct_lip,paired = TRUE)[3]))

test_results_lip_time<-
  test_results_lip_time %>%
  arrange(p.wilcox) %>%
  mutate(p.ad.fdr=p.adjust(p.wilcox, method = "fdr")) %>% # adjust p value from wilcox.test using BH method
  mutate(p.ad.sgof=sgof::SGoF(p.wilcox)$Adjusted.pvalues)  # adjust p value from wilcox.test using SGoF method

lip.vip<-PLSDA_test(df_correct_lip[,2:718],
                    label=df_correct_lip$group)
names(lip.vip)[2]<-"Lipidon"

test_results_lip_time_snv<-
  merge(lip.vip,test_results_lip_time,by="Lipidon") 
nrow(test_results_lip_time_snv %>% filter(VIP>=1 & p.ad.fdr<0.1))

write.table(test_results_lip_time_snv,"~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Lipidomic_snv.txt",sep = "\t",row.names = FALSE)
```
###Volcanol plot
```{r}
##input significant features
df.lip.annotation<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/Annotation/df.lip.annotation.txt") %>%
  janitor::row_to_names(row_number = 1)

results_lip_snv<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Lipidomic_snv(remove batch).txt") %>%
  mutate(Feature_type = case_when(`FC_M1/M0` >= 1.2 & p.wilcox<0.05  ~ "Up",
                              `FC_M1/M0` <= 0.85 & p.wilcox<0.05 ~ "Down",
                              TRUE ~ "Not significant")) %>%
  mutate(vip_cat=case_when(VIP>1 ~ "VIP > 1",
                           TRUE ~ "VIP ≤ 1")) %>%
   mutate(p_ad_cat=case_when(p.ad.sgof<0.05 ~ "Significant",
                           TRUE ~ "Not significant")) %>%
  mutate_at(vars(c ("vip_cat","p_ad_cat")),as.factor) %>%
  dplyr::rename(Features=Lipidon) %>%
  merge(df.lip.annotation %>% dplyr::select(Features,Class),by="Features")

sig_il_lip<-
  results_lip_snv %>%
  filter(Feature_type %in% c("Up", "Down")) %>%
  distinct(Features,.keep_all = TRUE)


#ChE dMePE LPC LPI PC PE PI PS NS=#CCCDCB
# #2F7DB9, #4E51A1 #43B14C, #914D9A, #F2EB2A, #F49E45, #E982B1, #65BFA3 
# Check gene_type categories ---------------------------------------------------
results_lip_snv %>%
  distinct(Feature_type) %>%
  pull()  

results_lip_snv[-which(results_lip_snv$Class %in% unique(sig_il_lip$Class)),"Class"] <-"Not significant"
results_lip_snv[which(results_lip_snv$p.ad.sgof>=0.05),"Class"] <-"Not significant"
results_lip_snv[which(results_lip_snv$FC_High.response.Low.response>=0.85 &results_lip_snv$FC_High.response.Low.response<=1.2),"Class"] <-"Not significant"

unique(results_lip_snv$Class)

cols <- c("Up"="#D8404D",
          "Down"= "#6485B5",
          "Not significant" = "#CCCDCB")
# 
# sizes <- c("VIP > 1"=5,"VIP ≤ 1"=3) 
# alphas <- c("Up" = 1, "Down" = 1, "Not significant" = 0.5)
shape<-c("Significant"=19,"Not significant"=17)

p.snv.lip<-
  results_lip_snv %>%
  ggplot(aes(x = LOG2FC,
             y = -log10(p.wilcox),
             shape=p_ad_cat)) + 
  geom_point(aes(colour = factor(Feature_type)),size=3) + 
  labs(colour = "", shape = "sgof-adjusted P value") +
  scale_shape_manual(values = shape)+
  #scale_colour_manual(values = cols,name="Metabolites Class") +
  scale_colour_manual(values = cols) +
  #scale_fill_manual(values = cols) + # Modify point colour
geom_text_repel(data = bind_rows(
    sig_il_lip %>% 
      filter(Feature_type == 'Up') %>% 
      arrange(p.wilcox,desc(abs(LOG2FC))) %>% 
      head(5),
    sig_il_lip %>% 
      filter(Feature_type == 'Down') %>% 
      arrange(p.wilcox,desc(abs(LOG2FC))) %>% 
      head(5)
  ), # Add labels last to appear as the top layer
                  aes(label = Features),
                  #family = "Times New Roman",
                  box.padding = 0.5,
                  size =3,
                  max.overlaps = getOption("ggrepel.max.overlaps", 200))+
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed", color="#C2C2C2") + 
  geom_vline(xintercept =log2(0.85),
             linetype = "dashed", color="#C2C2C2") +
  geom_vline(xintercept = log2(1.2),
             linetype = "dashed", color="#C2C2C2")+
  #scale_size_manual(values = sizes,name="VIP score") + # Modify point size
  #scale_alpha_manual(values = alphas) + # Modify point transparency
  #scale_shape_manual(values = shape, name="VIP score") +
  ggtitle("Altered Lipidomics in CoronaVac")+
  labs(x = expression("-Log"["2"]*" (Fold Change)"),
       y= expression("-Log"["10"]*" (P Value)"))+   theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(),          panel.background = element_rect(color = 'black', fill = 'transparent'),          legend.key = element_rect(fill = 'transparent')) +
       #y= expression("-Log"["10"]*" (P Value)"))+   theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(),          panel.background = element_rect(color = 'black', fill = 'transparent'),          legend.key = element_rect(fill = 'transparent')) +
  # + # Modify point size
  scale_x_continuous(breaks = c(seq(-2,2,1)),       
                     limits = c(-2,2))
p.snv.lip
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/volcano_snv_lip.pdf",width=9,height=8)
```
##Metabolimics
```{r}
df_correct_met<-df_correct_met_snv 
df_correct_met$group<-"M0"
df_correct_met[grepl("M1",rownames(df_correct_met)),"group"]<-"M1"
df_correct_met$group<-as.factor(df_correct_met$group)
df_correct_met<-df_correct_met[-which(grepl("VA379_M1",rownames(df_correct_met))),]

rownames(df_correct_met[grepl("M1",rownames(df_correct_met)),])
rownames(df_correct_met[grepl("M0",rownames(df_correct_met)),])
m1_rowname<-substr(rownames(df_correct_met[grepl("M1",rownames(df_correct_met)),]),1,5)
m0_rowname<-substr(rownames(df_correct_met[grepl("M0",rownames(df_correct_met)),]),1,5)
sort(m1_rowname)==sort(m0_rowname)
table(df_correct_met$group)

df_raw_met_snv_diff<-df_raw_met_snv 
##Use sva without scale as input data
# df_raw_met_snv_diff[df_raw_met_snv_diff<0]<-0
# 
# for (i in 1:ncol(df_raw_met_snv_diff)){
#   for (j in 1:nrow(df_raw_met_snv_diff)){
#     if(df_raw_met_snv_diff[j,i]==0) {df_raw_met_snv_diff[j,i]<-quantile(df_raw_met_snv_diff[,i],1/3)}
#   }
# }

# df_raw_met_snv_diff<-
#   df_raw_met_snv_diff %>% apply(2,log2) %>% as.data.frame()

df_raw_met_snv_diff$group<-"M0"
df_raw_met_snv_diff[grepl("M1",rownames(df_raw_met_snv_diff)),"group"]<-"M1"
df_raw_met_snv_diff$group<-as.factor(df_raw_met_snv_diff$group)

# t test
test_results_met_time <- data.frame(Metabolites = colnames(df_correct_met)[-ncol(df_correct_met)])

# Log2 (FC)
cn <- paste("FC_", "M1", "_", "M0", sep = "")

G1 <- df_raw_met_snv_diff[which(df_raw_met_snv_diff$group=="M0"), ]
G2 <- df_raw_met_snv_diff[which(df_raw_met_snv_diff$group=="M1"), ]
substr(rownames(G1) ,1,5)== substr(rownames(G2) ,1,5)
overlapp.id<-intersect(substr(rownames(G1) ,1,5),substr(rownames(G2) ,1,5))
rownames(G1)<-substr(rownames(G1) ,1,5)
rownames(G2)<-substr(rownames(G2) ,1,5)
G1<-G1[overlapp.id,-ncol(G1)]
G2<-G2[overlapp.id,-ncol(G2)]
fc.mat = G2/G1;
fc.all <- colMeans(fc.mat);

# t test
test_results_met_time <- data.frame(Metabolites = colnames(df_correct_met)[-ncol(df_correct_met)])
test_results_met_time<-
  cbind(test_results_met_time,fc.all)
# Log2 (FC)
# cn <- paste("FC_", "M1", "/", "M0", sep = "")
# test_results_met_time[cn] <- apply(df_correct_met[-ncol(df_correct_met)], 2, 
#                                    function(x) 
#                                      mean(as.numeric(x[which(df_correct_met$group == "M1")]))/
#                                      mean(as.numeric(x[which(df_correct_met$group == "M0")])))
test_results_met_time$LOG2FC <- log2(test_results_met_time[,2])

##wilcox.test
test_results_met_time$p.wilcox <- apply(df_correct_met[, -ncol(df_correct_met)], 2,
                                       function(x) unlist(wilcox.test(as.numeric(x) ~ df_correct_met$group, data = df_correct_met,paired = TRUE)[3]))

test_results_met_time<-
  test_results_met_time %>%
  arrange(p.wilcox) %>%
  mutate(p.ad.fdr=p.adjust(p.wilcox, method = "fdr")) %>% # adjust p value from wilcox.test using BH method
  mutate(p.ad.sgof=sgof::SGoF(p.wilcox)$Adjusted.pvalues)  # adjust p value from wilcox.test using SGoF method
names(df_correct_met)[761]<-"HMDB0034454"
met.vip<-PLSDA_test(df_correct_met[,-ncol(df_correct_met)],
                    label=df_correct_met$group)
names(met.vip)[2]<-"Metabolites"

test_results_met_time_snv<-
  merge(met.vip,test_results_met_time,by="Metabolites") %>%
  mutate(Match_ID=sub("\\__.*","",Metabolites)) %>%
  merge(read.xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/KEGG_ID.xlsx"),by="Match_ID")

dim(test_results_met_time_snv %>% filter(p.ad.fdr<0.1))

write.table(test_results_met_time_snv ,"~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Metabolomics_snv.txt",sep = "\t",row.names = FALSE)
```
###Volcanol plot
```{r}
##input significant features
df.met.annotation<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Processed_data/df.met.annotation.txt") 

results_met_snv<-
  test_results_met_time_snv %>%
  mutate(Feature_type = case_when(`FC_M1/M0` >= 1.2 & p.wilcox<0.05  ~ "Up",
                                  `FC_M1/M0` <= 0.85 & p.wilcox<0.05 ~ "Down",
                                  TRUE ~ "Not significant")) %>%
  mutate(vip_cat=case_when(VIP>1 ~ "VIP > 1",
                           TRUE ~ "VIP ≤ 1")) %>%
  mutate(p_ad_cat=case_when(p.ad.sgof<0.05 ~ "Significant",
                           TRUE ~ "Not significant")) %>%
  mutate_at(vars("vip_cat"),as.factor) %>%
  dplyr::rename(Features=metidon) %>%
  merge(df.met.annotation %>% 
          dplyr::rename(Features=Batch01_Name,Class=Batch01_Class) %>% 
          dplyr::select(Features,Class),by="Features")

sig_il_met<-
  results_met_snv %>%
  filter(Feature_type %in% c("Up", "Down")) %>%
  distinct(Features,.keep_all = TRUE)


#ChE dMePE LPC LPI PC PE PI PS NS=#CCCDCB
# #2F7DB9, #4E51A1 #43B14C, #914D9A, #F2EB2A, #F49E45, #E982B1, #65BFA3 
# Check gene_type categories ---------------------------------------------------
results_met_snv %>%
  distinct(Feature_type) %>%
  pull()  

results_met_snv[-which(results_met_snv$Class %in% unique(sig_il_met$Class)),"Class"] <-"Not significant"
results_met_snv[which(results_met_snv$p.ad.sgof>=0.05),"Class"] <-"Not significant"
results_met_snv[which(results_met_snv$FC_High.response.Low.response>=0.85 &results_met_snv$FC_High.response.Low.response<=1.2),"Class"] <-"Not significant"

unique(results_met_snv$Class)

cols <- c("Up"="#D8404D",
          "Down"= "#6485B5",
          "Not significant" = "#CCCDCB")
# 
# sizes <- c("VIP > 1"=5,"VIP ≤ 1"=3) 
# alphas <- c("Up" = 1, "Down" = 1, "Not significant" = 0.5)
shape<-c("Significant"=19,"Not significant"=17)

p.snv.met<-results_met_snv %>%
  ggplot(aes(x = LOG2FC,
             y = -log10(p.wilcox),
             shape=p_ad_cat)) + 
  geom_point(aes(colour = factor(Feature_type)),size=3) + 
  labs(colour = "", shape = "sgof-adjusted P value") +
  scale_shape_manual(values = shape)+
    scale_colour_manual(values = cols) +
  #scale_fill_manual(values = cols) + # Modify point colour
  geom_text_repel(data = bind_rows(
    sig_il_met %>% 
      filter(Feature_type == 'Up') %>% 
      arrange(p.wilcox,desc(abs(LOG2FC))) %>% 
      head(5),
    sig_il_met %>% 
      filter(Feature_type == 'Down') %>% 
      arrange(p.wilcox,desc(abs(LOG2FC))) %>% 
      head(5)
  ), # Add labels last to appear as the top layer
                  aes(label = Features),
                  #family = "Times New Roman",
                  box.padding = 0.5,
                  size =3,
                  max.overlaps = getOption("ggrepel.max.overlaps", 200))+
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed", color="#C2C2C2") + 
  geom_vline(xintercept =log2(0.85),
             linetype = "dashed", color="#C2C2C2") +
  geom_vline(xintercept = log2(1.2),
             linetype = "dashed", color="#C2C2C2")+
  #scale_size_manual(values = sizes,name="VIP score") + # Modify point size
  #scale_alpha_manual(values = alphas) + # Modify point transparency
  #scale_shape_manual(values = shape, name="VIP score") +
  ggtitle("Altered Metabolomics in CoronaVac")+
  labs(x = expression("-Log"["2"]*" (Fold Change)"),
       y= expression("-Log"["10"]*" (P Value)"))+   theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(),          panel.background = element_rect(color = 'black', fill = 'transparent'),          legend.key = element_rect(fill = 'transparent')) +
       #y= expression("-Log"["10"]*" (P Value)"))+   theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(),          panel.background = element_rect(color = 'black', fill = 'transparent'),          legend.key = element_rect(fill = 'transparent')) +
  # + # Modify point size
  scale_x_continuous(breaks = c(seq(-2,2,1)),       
                     limits = c(-2,2))
p.snv.met
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/volcano_snv_met.pdf",width=9,height=7)
```
###Bar Plot
```{r}



ggplot(kegg_rich_fdr@result %>% arrange(-Count) %>% head(5),aes(x=Count,y=reorder(Description,Count)))+
  geom_bar(aes(fill=pvalue),stat = "identity",alpha=0.7,width = 0.8) + 
  scale_fill_distiller(palette = "PiYG")+
  geom_text(aes(x=Count+0.3,y=Description,label=Count))+
  theme_test()+
  xlim(c(0,max(kegg_rich_fdr@result$Count)+1))+
  theme(legend.position = 'right')+
  theme(axis.text.y = element_text(face = 'plain',size=10))+
  ylab("Pathways")

ggsave(file = paste0("~/OneDrive - The Chinese University of Hong Kong/Project/Multi-omics/Results/Pathway_enrichment/diff/Enrichment_plot_CoronaVac.pdf"),height=5,width=8)




##Divided the significant features as upregulated and downregulated
for (i in c(0.8,0.85,0.75)){
  for (j in c(1.15,1.2,1.25)){
    df.snv.barplot.Met_up<-
      read.table("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Metabolomics_snv.txt",header=TRUE) %>%
      filter( p.ad.sgof<0.05) %>% 
      filter(`FC_M1.M0`>=j) %>%
      #match the df.meta.overall using raw dataset
      merge(fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Processed_data/df.met.annotation.txt",header=TRUE) %>%
              mutate(Metabolites=paste0(HMDB,"__",Batch01_Name)) %>%
              dplyr::select(Metabolites,Batch01_Class,Batch01_Name), by="Metabolites") %>%
      mutate(group="Metabolomics")
    
    library(CTDext)
    df_met_module_kegg_up<-
      df.snv.barplot.Met_up %>%
      filter(KEGG_ID!="NA")
    
    df_KEGG<-fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/KEGG_pathway_database/kegg_tgo_pathway/tgo_KEGG_com.tsv')
    com_ano <- df_KEGG %>% select(KEGG.ID,pathway_id,pathway_name)
    gene_select_up <- df_met_module_kegg_up$KEGG_ID
    #KEGG 富集分析
    #默认以所有注释到 KEGG 的基因为背景集，也可通过 universe 参数指定其中的一个子集作为背景集
    #默认以 p<0.05 为标准，Benjamini 方法校正 p 值，q 值阈值 0.2
    #默认输出 top500 富集结果
    
    kegg_rich_fdr_up <- clusterProfiler::enricher(gene = gene_select_up,
                                                  TERM2GENE = com_ano[,c('pathway_id', 'KEGG.ID')], 
                                                  TERM2NAME = com_ano[,c('pathway_id', 'pathway_name')],
                                                  pvalueCutoff = 0.1, 
                                                  pAdjustMethod = 'fdr', 
                                                  qvalueCutoff = 0.1, 
                                                  maxGSSize = 5000)
    
    Figure.title.ensembl<-paste0("Enrichment_plot_CoronaVac_Upregulation_",i,"_",j)
    
    pdf(file = paste0("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/WGCNA/Metabolomics/diff/SNV/", i,"_",j,"up.pdf"),height=10,width=10)
    plot_i_j<-clusterProfiler::dotplot(kegg_rich_fdr_up, showCategory=20,title=Figure.title.ensembl)
    print(plot_i_j)
    dev.off()
    
    df.snv.barplot.Met_down<-
      read.table("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Metabolomics_snv.txt",header=TRUE) %>%
      filter( p.ad.sgof<0.05) %>% 
      filter(`FC_M1.M0`<=i) %>%
      #match the df.meta.overall using raw dataset
      merge(fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Processed_data/df.met.annotation.txt",header=TRUE) %>%
              mutate(Metabolites=paste0(HMDB,"__",Batch01_Name)) %>%
              dplyr::select(Metabolites,Batch01_Class,Batch01_Name), by="Metabolites") %>%
      mutate(group="Metabolomics")
    
    library(CTDext)
    df_met_module_kegg_down<-
      df.snv.barplot.Met_down %>%
      filter(KEGG_ID!="NA")
    
    df_KEGG<-fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/KEGG_pathway_database/kegg_tgo_pathway/tgo_KEGG_com.tsv')
    com_ano <- df_KEGG %>% select(KEGG.ID,pathway_id,pathway_name)
    gene_select_down <- df_met_module_kegg_down$KEGG_ID
    #KEGG 富集分析
    #默认以所有注释到 KEGG 的基因为背景集，也可通过 universe 参数指定其中的一个子集作为背景集
    #默认以 p<0.05 为标准，Benjamini 方法校正 p 值，q 值阈值 0.2
    #默认输出 top500 富集结果
    
    kegg_rich_fdr_down <- clusterProfiler::enricher(gene = gene_select_down,
                                                    TERM2GENE = com_ano[,c('pathway_id', 'KEGG.ID')], 
                                                    TERM2NAME = com_ano[,c('pathway_id', 'pathway_name')],
                                                    pvalueCutoff = 0.1, 
                                                    pAdjustMethod = 'fdr', 
                                                    qvalueCutoff = 0.1, 
                                                    maxGSSize = 5000)
    
    Figure.title.ensembl<-paste0("Enrichment_plot_CoronaVac_Downregulation_",i,"_",j)
    
    pdf(file = paste0("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/WGCNA/Metabolomics/diff/SNV/", i,"_",j,"down.pdf"),height=10,width=10)
    plot_i_j<-clusterProfiler::dotplot(kegg_rich_fdr_down, showCategory=20,title=Figure.title.ensembl)
    print(plot_i_j)
    dev.off()
    
  }
}

```
#ENRICHMENT FOR BOTH
```{r}
#Input enrichment results and differential gene results

df.bnt.barplot.Met<-
  read.table("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Metabolomics_BNT.txt",header=TRUE) %>%
  filter( p.ad.fdr<=0.1) %>% 
  #filter(VIP>=1)%>%
  #filter(`FC_M1.M0`<=i|`FC_M1.M0`>=j) %>%
  #match the df.meta.overall using raw dataset
  merge(fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Processed_data/df.met.annotation.txt",header=TRUE) %>%
  mutate(Metabolites=paste0(HMDB,"__",Batch01_Name)) %>%
  dplyr::select(Metabolites,Batch01_Class,Batch01_Name), by="Metabolites") %>%
  mutate(group="Metabolomics")

library(CTDext)
df_met_module_kegg<-
  df.bnt.barplot.Met %>%
  filter(KEGG_ID!="NA")
# %>%
#   mutate(HMDB=sub("\\__.*","",Metabolites)) %>%
#   mutate(KEGG_ID=case_when(substr(HMDB,1,1)!="H"~ HMDB,
#                            TRUE~ CTDext::data.HMDBtoKEGG(HMDB)[,2]))

df_KEGG<-fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/KEGG_pathway_database/kegg_tgo_pathway/tgo_KEGG_com.tsv')
com_ano <- df_KEGG %>% select(KEGG.ID,pathway_id,pathway_name)
gene_select <- df_met_module_kegg$KEGG_ID
#KEGG 富集分析
#默认以所有注释到 KEGG 的基因为背景集，也可通过 universe 参数指定其中的一个子集作为背景集
#默认以 p<0.05 为标准，Benjamini 方法校正 p 值，q 值阈值 0.2
#默认输出 top500 富集结果

kegg_rich_fdr_BNT <- clusterProfiler::enricher(gene = gene_select,
                      TERM2GENE = com_ano[,c('pathway_id', 'KEGG.ID')], 
                      TERM2NAME = com_ano[,c('pathway_id', 'pathway_name')],
                      pvalueCutoff = 0.1, 
                      pAdjustMethod = 'fdr', 
                      qvalueCutoff = 0.1, 
                      maxGSSize = 5000)
df.snv.barplot.Met<-
  read.table("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Metabolomics_snv.txt",header=TRUE) %>%
  filter( p.ad.sgof<=0.1) %>% 
  #filter(`FC_M1.M0`<=i|`FC_M1.M0`>=j) %>%
  #match the df.meta.overall using raw dataset
  merge(fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/omics/Lip_Met/Processed_data/df.met.annotation.txt",header=TRUE) %>%
  mutate(Metabolites=paste0(HMDB,"__",Batch01_Name)) %>%
  dplyr::select(Metabolites,Batch01_Class,Batch01_Name), by="Metabolites") %>%
  mutate(group="Metabolomics")

library(CTDext)
df_met_module_kegg<-
  df.snv.barplot.Met %>%
  filter(KEGG_ID!="NA")
# %>%
#   mutate(HMDB=sub("\\__.*","",Metabolites)) %>%
#   mutate(KEGG_ID=case_when(substr(HMDB,1,1)!="H"~ HMDB,
#                            TRUE~ CTDext::data.HMDBtoKEGG(HMDB)[,2]))

df_KEGG<-fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/database/KEGG_pathway_database/kegg_tgo_pathway/tgo_KEGG_com.tsv')
com_ano <- df_KEGG %>% select(KEGG.ID,pathway_id,pathway_name)
gene_select <- df_met_module_kegg$KEGG_ID
#KEGG 富集分析
#默认以所有注释到 KEGG 的基因为背景集，也可通过 universe 参数指定其中的一个子集作为背景集
#默认以 p<0.05 为标准，Benjamini 方法校正 p 值，q 值阈值 0.2
#默认输出 top500 富集结果

kegg_rich_fdr_SNV <- clusterProfiler::enricher(gene = gene_select,
                      TERM2GENE = com_ano[,c('pathway_id', 'KEGG.ID')], 
                      TERM2NAME = com_ano[,c('pathway_id', 'pathway_name')],
                      pvalueCutoff = 0.1, 
                      pAdjustMethod = 'fdr', 
                      qvalueCutoff = 0.1, 
                      maxGSSize = 5000)

df.kegg.enrich<-
  bind_rows(kegg_rich_fdr_BNT@result %>% arrange(-Count)  %>% mutate(group="BNT162b2"),
            kegg_rich_fdr_SNV@result %>% arrange(-Count) %>% mutate(group="CoronaVac")) %>%
  filter(Count>=2) %>%
  mutate(y.color=
           case_when(group=="BNT162b2" ~ "#64b4e4",
                     group=="CoronaVac" ~ "#FF6F00FF")) %>%
  mutate(group=as.factor(group))

write.csv(df.kegg.enrich,"~/OneDrive - The Chinese University of Hong Kong/Project/Multi-omics/Results/Pathway_enrichment/diff/enrichment.csv")

ggplot(df.kegg.enrich,aes(x=Count,y=reorder(Description,Count)))+
  geom_bar(aes(fill=qvalue),stat = "identity",alpha=0.7,width = 0.8) + 
  scale_fill_distiller(palette = "PiYG")+
  facet_grid(~df.kegg.enrich$group)+
  geom_text(aes(x=Count+0.3,y=Description,label=Count))+
  theme_test()+
  xlim(c(0,max(df.kegg.enrich$Count)+1))+
  theme(legend.position = 'right')+
  theme(axis.text.y = element_text(face = 'plain',size=10))+
  ylab("Pathways")

ggsave(file = paste0("~/OneDrive - The Chinese University of Hong Kong/Project/Multi-omics/Results/Pathway_enrichment/diff/Enrichment_plot.pdf"),height=10,width=13)


  diff_enrich_BNT_id<-df.kegg.enrich %>% filter(group=="BNT162b2") %>% filter(Description=="Neuroactive ligand-receptor interaction")
  diff_enrich_BNT_id<-unlist(strsplit(diff_enrich_BNT_id$geneID,"/"))
  diff_enrich_BNT_id #[1] "C06124" "C13856"
  
  df.bnt.barplot.Met %>% filter(KEGG_ID %in% diff_enrich_BNT_id ) 
#HMDB0000277__D-Erythro-sphingosine 1-phosphate; HMDB0004666__2-Arachidonoyl glycerol

 ##Use batch-effect corrected data

data = 
  df_raw_met_bnt_diff %>%
  mutate(across(where(is.character),as.numeric)) %>%
               rownames_to_column("rowname.new") %>%
               mutate(group=substr(rowname.new,7,8),
                      rowname.new=substr(rowname.new,1,5)) %>%
               merge(df.outcome %>% mutate(rowname.new=substr(Subject_no.,1,5)) %>%
                       dplyr::rename(Vac_type=Vaccine_type) %>%
                       dplyr::select("rowname.new","batch","Vac_type"), by="rowname.new") %>%
  dplyr::select(`HMDB0004666__2-Arachidonoyl glycerol`,batch,group,Vac_type) %>%
  dplyr::rename("Metabolites"="HMDB0004666__2-Arachidonoyl glycerol") %>%
  mutate(Metabolites_log=log2(Metabolites)) %>%
  mutate(batch=case_when(batch=="1" ~ "1", batch=="2" ~ "1",TRUE~ "2"))

#aggregate(Metabolites ~ group + Age +Gender, data = data %>% filter(Vac_type=="B") , mean)

library(ggpubr)

ggboxplot(data %>% filter (Vac_type=="B"),"group",y="Metabolites",color="group",add="mean")+
    facet_grid(~batch)
  
```
##Transcriptomics
###Vocanol plot-SNV
```{r} 
res.snv.1<-
  fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Transcriptomics/M1_M0_Limma_SNV.txt') %>%
  column_to_rownames("V1") 


res.snv.1<-
  res.snv.1 %>%
  mutate(p_ad_cat=case_when(padj<0.05 ~ "Significant",
                            TRUE ~ "Not significant")) %>%
  mutate(sig=case_when(log2FoldChange >= log2(1.5) & padj <0.05 ~ "Up",
                       log2FoldChange <= -log2(1.5) & padj <0.05 ~'Down',
         TRUE ~ "Not significant"))
summary(as.factor(res.snv.1$sig))
#输出选择的差异基因总表
res.snv.1_select <- subset(res.snv.1, sig %in% c('Up', 'Down'))
res.snv.1_select$feature<-rownames(res.snv.1_select)
#默认情况下，横轴展示 log2FoldChange，纵轴展示 -log10 转化后的 p value
overlap_gene<-intersect(res.snv.1_select$feature,res.bnt.1_select$feature)
res.snv.1_select[overlap_gene,]
res.bnt.1_select[overlap_gene,]


shape<-c("Significant"=19,"Not significant"=17)
p.snv.rna <- ggplot(data = res.snv.1, aes(x = log2FoldChange, y = -log10(padj), color = sig,
                                          shape=p_ad_cat)) +
  labs(colour = "", shape = "adjusted P value") +
  scale_shape_manual(values = shape)+
  geom_point(size = 3) +  #绘制散点图
  scale_color_manual(values = c('#D8404D', '#CCCDCB', '#6485B5'), limits = c('Up', 'Not significant', 'Down')) +  #自定义点的颜色
  #labs(x = 'log2 Fold Change', y = '-log10 adjust p-value', title = 'M1 vs M0', color = '') +  #坐标轴标题
  theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(), #背景色、网格线、图例等主题修改
        panel.background = element_rect(color = 'black', fill = 'transparent'), 
        legend.key = element_rect(fill = 'transparent')) +
  geom_vline(xintercept = c(-log2(1.5), log2(1.5)), lty = 3, color = 'black') +  #添加阈值线
  geom_hline(yintercept = -log10(0.05), lty = 3, color = 'black') +
  geom_text_repel(data =  bind_rows(
    res.snv.1_select %>% 
      filter(sig == 'Up') %>% 
      arrange(desc(abs(log2FoldChange)),padj) %>% 
      head(5),
    res.snv.1_select %>% 
      filter(sig == 'Down') %>% 
      arrange(desc(abs(log2FoldChange)),padj) %>% 
      head(5)
  ) %>% 
    mutate(feature=case_when(grepl("__NA__NA",feature) ~ gsub("\\..*", "", feature),
                        TRUE ~ gsub("__", "",str_extract(feature, "__(.*?)__")))), # Add labels last to appear as the top layer
  aes(label = feature),
  #family = "Times New Roman",
  box.padding = 0.5,
  size =3,
  max.overlaps = getOption("ggrepel.max.overlaps", 600))+
  guides(color = guide_legend(override.aes = list(size = 3)))+
  ggtitle("Altered Transcriptomics in CoronaVac")+
  labs(x = expression("-Log"["2"]*" (Fold Change)"),
       y= expression("-Log"["10"]*" (Adjusted P Value)"))+   theme(plot.title = element_text(hjust = 0.5, size = 14), panel.grid = element_blank(),          panel.background = element_rect(color = 'black', fill = 'transparent'),          legend.key = element_rect(fill = 'transparent'))
p.snv.rna
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Transcriptomics/volcano_snv_rna.pdf",width=12,height=15)

ggarrange(p.bnt.rna,p.snv.rna,common.legend = TRUE)
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/Transcriptomics/volcano_overall_rna.pdf",width=12,height=7)

```
###Enrichment plot
```{r}
egmt_ensemble_bnt<-
  readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_BNT.rds")
View(egmt_ensemble_bnt@result)
egmt_ensemble_snv<-
  readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_SNV.rds")

egmt_ensemble_bnt_M6<-
  readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_adjust_M6_M0_BNT.rds")
egmt_ensemble_snv_M6<-
  readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_adjust_M6_M0_SNV.rds")

library(clusterProfiler)
dotplot(egmt_ensemble_bnt,x="Count", showCategory=30, split=c(".sign"),color="p.adjust",label_format=65) + 
  facet_grid(ONTOLOGY~.sign,scales = "free_y", space = "free_y")
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/Dotplot_bnt.pdf",width=13,height=15)

dotplot(egmt_ensemble_snv,x="Count", showCategory=30, split=c(".sign"),color="p.adjust",label_format=65) + 
  facet_grid(ONTOLOGY~.sign,scales = "free_y", space = "free_y")
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/Dotplot_snv.pdf",width=12,height=10)

library(clusterProfiler)
g1<-dotplot(egmt_ensemble_bnt_M6,x="Count", showCategory=50, split=c(".sign"),color="p.adjust",label_format=65) + 
  facet_grid(ONTOLOGY~.sign,scales = "free_y", space = "free_y")
g1
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/Dotplot_bnt_M6.pdf",width=13,height=15)

View(egmt_ensemble_bnt_M6@result)


g2<-dotplot(egmt_ensemble_snv_M6,x="Count", showCategory=50, split=c(".sign"),color="p.adjust",label_format=65) + 
  facet_grid(ONTOLOGY~.sign,scales = "free_y", space = "free_y")
g2
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/Dotplot_snv_M6.pdf",width=12,height=10)
library(ggpubr)
ggarrange(g1,g2)
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/Dotplot_overall_M6.png",width=30,height=20)
```
#Venn plot between vaccine types
##Lipidomics
```{r}
library(ggvenn)
library(VennDiagram)
Venn_lip_bnt<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Lipidomic_BNT(remove batch).txt") %>%
  mutate(Feature_type = case_when(`FC_M1/M0` >= 1.2 & p.wilcox<0.05  ~ "Up",
                              `FC_M1/M0` <= 0.85 & p.wilcox<0.05 ~ "Down",
                              TRUE ~ "Not significant")) %>%
  mutate(vip_cat=case_when(VIP>1 ~ "VIP > 1",
                           TRUE ~ "VIP ≤ 1")) %>%
  mutate_at(vars("vip_cat"),as.factor) %>%
  dplyr::rename(Features=Lipidon) %>%
  merge(df.lip.annotation %>% dplyr::select(Features,Class),by="Features") %>%
  filter(Feature_type %in% c("Up", "Down")) %>%
  distinct(Features,.keep_all = TRUE)

Venn_lip_snv<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Lipidomic_snv(remove batch).txt") %>%
  mutate(Feature_type = case_when(`FC_M1/M0` >= 1.2 & p.wilcox<0.05  ~ "Up",
                                  `FC_M1/M0` <= 0.85 & p.wilcox<0.05 ~ "Down",
                                  TRUE ~ "Not significant")) %>%
  mutate(vip_cat=case_when(VIP>1 ~ "VIP > 1",
                           TRUE ~ "VIP ≤ 1")) %>%
  mutate_at(vars("vip_cat"),as.factor) %>%
  dplyr::rename(Features=Lipidon) %>%
  merge(df.lip.annotation %>% dplyr::select(Features,Class),by="Features") %>%
  filter(Feature_type %in% c("Up", "Down")) %>%
  distinct(Features,.keep_all = TRUE)

Venn_lip_overall<-list(
  BNT162b2=Venn_lip_bnt$Features,
  CoronaVac=Venn_lip_snv$Features
)
Venn_lip_overall_plot<-ggvenn(
  Venn_lip_overall, 
  show_elements = F, label_sep = "\n",
  fill_color = c("#64B4E5", "#D65D0F"),
  stroke_size = 0.5, set_name_size = 4
)
Venn_lip_overall_plot
#ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Veen_plot_volcano/Veen_plot_lip.pdf",width=12,height=10)
lip.bnt.intersect<-intersect(Venn_lip_bnt$Features,Venn_lip_snv$Features)
Venn_lip_bnt %>%
  filter(Features %in% lip.bnt.intersect)
```
##Metabolomics
```{r}
Venn_met_bnt<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Metabolomics_BNT(remove batch).txt") %>%
  mutate(Feature_type = case_when(`FC_M1/M0` >= 1.2 & p.wilcox<0.05  ~ "Up",
                                  `FC_M1/M0` <= 0.85 & p.wilcox<0.05 ~ "Down",
                                  TRUE ~ "Not significant")) %>%
  mutate(vip_cat=case_when(VIP>1 ~ "VIP > 1",
                           TRUE ~ "VIP ≤ 1")) %>%
  mutate_at(vars("vip_cat"),as.factor) %>%
  dplyr::rename(Features=metidon) %>%
  merge(df.met.annotation %>% 
          dplyr::rename(Features=Batch01_Name,Class=Batch01_Class) %>% 
          dplyr::select(Features,Class),by="Features") %>%
  filter(Feature_type %in% c("Up", "Down")) %>%
  distinct(Features,.keep_all = TRUE)

Venn_met_snv<-
  fread("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Differential_Metabolomics_snv(remove batch).txt") %>%
  mutate(Feature_type = case_when(`FC_M1/M0` >= 1.2 & p.wilcox<0.05  ~ "Up",
                                  `FC_M1/M0` <= 0.85 & p.wilcox<0.05 ~ "Down",
                                  TRUE ~ "Not significant")) %>%
  mutate(vip_cat=case_when(VIP>1 ~ "VIP > 1",
                           TRUE ~ "VIP ≤ 1")) %>%
  mutate_at(vars("vip_cat"),as.factor) %>%
  dplyr::rename(Features=metidon) %>%
  merge(df.met.annotation %>% 
          dplyr::rename(Features=Batch01_Name,Class=Batch01_Class) %>% 
          dplyr::select(Features,Class),by="Features") %>%
  filter(Feature_type %in% c("Up", "Down")) %>%
  distinct(Features,.keep_all = TRUE)

Venn_met_overall<-list(
  BNT162b2=Venn_met_bnt$Features,
  CoronaVac=Venn_met_snv$Features
)
Venn_met_overall_plot<-ggvenn(
  Venn_met_overall, 
  show_elements = F, label_sep = "\n",
  fill_color = c("#64B4E5", "#D65D0F"),
  stroke_size = 0.5, set_name_size = 4
)
Venn_met_overall_plot
#ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Veen_plot_volcano/Veen_plot_met.pdf",width=12,height=10)
met_intersect<-
  intersect(Venn_met_bnt$Features,Venn_met_snv$Features)
```
##Transcriptomics
```{r}
Venn_rna_overall<-
  list(
   BNT162b2=res.bnt.1_select$feature,
  CoronaVac=res.snv.1_select$feature
  )
Venn_rna_overall_plot<-ggvenn(
  Venn_rna_overall, 
  show_elements = F, label_sep = "\n",
  fill_color = c("#64B4E5", "#D65D0F"),
  stroke_size = 0.5, set_name_size = 4
)
Venn_rna_overall_plot
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Veen_plot_volcano/Veen_plot_rna.pdf",width=12,height=10)
rna_intersect<-
  intersect(rownames(res.bnt.1_select),rownames(res.snv.1_select))
```
####GGarrange
```{r}
library(ggpubr)
ggarrange(p.bnt.lip,p.snv.lip,Venn_lip_overall_plot,
          p.bnt.met,  p.snv.met,Venn_met_overall_plot,
          p.bnt.rna, p.snv.rna,Venn_rna_overall_plot,
          ncol = 3, nrow = 3, common.legend = TRUE,legend="right")
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/Overall.plot.v2.pdf",width=15,height=15)
```
#differential counts fro features
```{r}
test<-
  read.table("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Differential_analysis_paired/count_summary.txt") %>%
  mutate(row_group=paste0(Omic,Regulation)) %>%
  mutate(row_group=factor(row_group,levels=c( "LipidomicsDown" ,   "LipidomicsUp" , "MetabolomicsDown" ,  "MetabolomicsUp"  ,"TranscriptomicDown","TranscriptomicUp"),
                          labels=c( "Downregulated (L)" ,   "Upregulated (L)" ,  "Downregulated (M)" ,   "Upregulated (M)" , "Downregulated (T)" ,   "Upregulated (T)" ))) %>%
  mutate(month=factor(month,levels=c("BNT_M0_M1", "BNT_M0_M6", "SNV_M0_M1", "SNV_M0_M6"),labels=c("BNT162b2: Baseline vs. 1m pv.",
                                                                                                  "BNT162b2: Baseline vs. 6m pv.",
                                                                                                  "CoronaVac: Baseline vs. 1m pv.",
                                                                                                  "CoronaVac: Baseline vs. 6m pv.")))
names(test) #[1] "month"      "Omic"       "Regulation" "count" ,row_group 
cols=c(Transcriptomic="#E6824C",
          Metabolomics="#E4C658",
          Lipidomics="#7FC1C6")
shape=c(Up=2,Down=6)

ggplot(test, aes(month,row_group)) +
  geom_point(aes(fill = Omic, size = count), color = "black", shape = 21) +
  scale_size()+
  scale_fill_manual(values = cols)+  # Adjust if needed
  theme_minimal() +  # Start with a minimal theme
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border = element_rect(colour = "black", fill = NA, size = 0.5))+
  theme(plot.margin = margin(1, 1, 1, 1, "cm"),
        axis.text.x = element_text(size = 8, angle = 45, vjust = 1, hjust = 1,face="bold"),
        axis.text.y = element_text(size = 8,face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8,face = "bold"),
        legend.spacing.y = unit(0.3, 'cm'),
        legend.key.size = unit(0.3, 'cm'),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),  # Remove minor grid lines
        panel.background = element_rect(fill = "white", colour = NA)) +  # White background
  labs(fill = "Omics", size = "Count", x = "",y="")
ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/Result/Final/Longitudinal_changes/scatter.plot.pdf",width=5,height=5)
```

#Corplot between BNT & SNV
```{r}
test_results_lip_time_bnt %>% filter(p.wilcox<0.05) %>% filter(`FC_M1/M0`>=1.2| `FC_M1/M0`<=0.85) %>% filter( VIP>1)
diff.rna.bnt.time<-
  fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/M1_M0.DESeq2(BNT).txt') %>%
  column_to_rownames("V1") %>%
  #arrange(pvalue) %>%
  #mutate(p.sgof=sgof::SGoF(pvalue)$Adjusted.pvalues) %>%
  mutate(sig=case_when(log2FoldChange >= 1 & padj <0.05 ~ 'up',
                       log2FoldChange <= -1 & padj <0.05 ~ 'down',
                       TRUE ~ 'none')) %>%
  filter(sig!='none') %>%
  mutate(group="BNT162b2")%>%
  rownames_to_column(var="Features") 

diff.rna.snv.time<-
  fread('~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results_0528/Differentially_analyses/M1_M0.DESeq2(SNV).txt') %>%
  column_to_rownames("V1") %>%
  arrange(pvalue) %>%
  mutate(p.sgof=sgof::SGoF(pvalue)$Adjusted.pvalues) %>%
  mutate(sig=case_when(log2FoldChange >= 1 & padj <0.05 ~ 'up',
                       log2FoldChange <= -1 & padj <0.05 ~ 'down',
                       TRUE ~ 'none')) %>%
  filter(sig!='none') %>%
  mutate(group="CoronaVac") %>%
  rownames_to_column(var="Features")

output.rna<-rbind(diff.rna.bnt.time,diff.rna.snv.time) %>%
  #select(-padj) %>%
  #filter(padj<0.1) %>%
  #mutate(log2FoldChange=as.numeric(log2FoldChange),padj=as.numeric(padj),p.sgof<-as.numeric(p.sgof))
  mutate(log2FoldChange=as.numeric(log2FoldChange),p.sgof=as.numeric(p.sgof)) 

# rna.overallp<-as.data.frame(table(output.rna$feature)) %>% filter(Freq>1)
# 
# output.rna<-
#   output.rna %>%
#   filter(feature %in% rna.overallp$Var1)
# 
# intersect(rownames(res.bnt.1_select),rna.overallp$Var1)
rna.overallp<-as.data.frame(table(output.rna$Features)) %>% filter(Freq>1)
ggplot(output.rna, aes(group,Features)) +
  geom_point(aes(fill = log2FoldChange, size = -log10(p.sgof)), color = "black", shape = 21) +
  scale_size()+
  #scale_size(range = c(1, 3), breaks = c(2, 4, 6, 8)) +  # c(2, 4, 6, 8) c(2, 4, 6)
  scale_fill_viridis_c(option = "plasma")+
  # scale_fill_viridis_c(direction = -1, begin = 0.2, option = "A",
  #                      breaks = c(2, 3, 4, 5, 6)) +
  #theme_dendro() +
  theme(plot.margin = margin(1, 1, 1, 1, "cm")) +
  labs(fill = "Log2FC", size = "-Log10 (P value)") +
  theme(axis.text.x = element_text(size = 8, face = "plain", colour = "black",
                                   angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 8, face = "plain", colour = "black")) +
  theme(legend.text = element_text(size = 6, face = "plain", colour = "black"),
        legend.title = element_text(size = 6, face = "plain", colour = "black"),
        legend.spacing.y = unit(0.3, 'cm'),
        legend.key.size = unit(0.3, 'cm'))
##ggsave("~/Multi-omics_V2_20220922/Result/Difference analysis/ Feature list/cor.dot.plot.rna.timepoint.pdf",height=15,width=12)

```
##Pathways longitudinal changes
```{r}
# 获取整个 GO 层级结构
secondary_ids <- c("GO:0044848", "GO:0044419", "GO:0051703", "GO:0065007", "GO:0009987", "GO:0098754", "GO:0032502",
                   "GO:0040007", "GO:0042592", "GO:0002376", "GO:0051179", "GO:0040011", "GO:0008152", "GO:0032501",
                   "GO:0048519", "GO:0043473", "GO:0048518", "GO:0050789", "GO:0000003", "GO:0022414", "GO:0050896",
                   "GO:0048511", "GO:0016032")
library(GOSim)
library(dplyr)
# 准备一个列表来存储所有层级结构
all_hierarchy <- list()

for (ontology in c("MF", "BP", "CC")) {
  setOntology(ontology)
  all_hierarchy[[ontology]] <- getAncestors()
}

# 映射函数，用于查找 GO ID 的所有祖先，并找到二级分类
map_to_secondary <- function(go_id, all_hierarchy, secondary_ids) {
  ancestors <- all_hierarchy[["BP"]][[go_id]]
  # 找到和二级 IDs 匹配的祖先
  secondary_matches <- ancestors %in% secondary_ids
  if (any(secondary_matches)) {
    secondary_id <- ancestors[secondary_matches][1]  # 只取第一个匹配
    return(list(raw_id = go_id, secondary_id = secondary_id))
  } else {
    return(list(raw_id = go_id, secondary_id = go_id))
  }
}

# 映射 BNT 和 SNV 的 GO IDs
map_and_combine_results <- function(egmt_ensemble, group_name) {
  go_results <- egmt_ensemble@result %>% filter(ONTOLOGY == "BP")
  go_ids <- go_results$ID
  mapped_hierarchy <- lapply(go_ids, function(id) map_to_secondary(id, all_hierarchy, secondary_ids))
  mapped_hierarchy_df <- do.call(rbind, lapply(mapped_hierarchy, bind_rows)) %>% as.data.frame()
  mapped_hierarchy_df$group <- group_name
  return(mapped_hierarchy_df)
}

library(ggplot2)
BNT_M1<-readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_BNT.rds")

mapped_hierarchy_bnt_M1 <- map_and_combine_results(BNT_M1, "BNT_M1")

SNV_M1<-readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_SNV.rds")
mapped_hierarchy_snv_M1<- map_and_combine_results(SNV_M1, "SNV_M1")
BNT_M6<-readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_adjust_M6_M0_BNT.rds")

mapped_hierarchy_bnt_M6 <- map_and_combine_results(BNT_M1, "BNT_M6")
SNV_M6<-readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_adjust_M6_M0_SNV.rds")
mapped_hierarchy_snv_M6<- map_and_combine_results(SNV_M1, "SNV_M6")

final_mapped_hierarchy <- rbind(mapped_hierarchy_bnt_M1, mapped_hierarchy_snv_M1,mapped_hierarchy_bnt_M6,mapped_hierarchy_snv_M6)


gsea_bnt_m1<-readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_BNT.rds")@result %>%
  filter(p.adjust<0.05) %>%
  mutate(Direction=case_when(NES>0 ~ "UP",TRUE ~ "DOWN"),
         Group="BNT162b2 1m pv. vs. baseline") %>%
  dplyr::select(ONTOLOGY,ID,Description,ID,Direction,Group,NES,p.adjust) %>%
  filter(ONTOLOGY=="BP") %>%
  merge(final_mapped_hierarchy %>% filter(group=="BNT_M1"),by.x="ID",by.y="raw_id") %>%
  dplyr::select(ID,Description,secondary_id,group,Direction,NES,p.adjust)

Annotation<-AnnotationDbi::select(GO.db, keys = gsea_bnt_m1$secondary_id, columns = "TERM", keytype = "GOID") 
Annotation.1st<-AnnotationDbi::select(GO.db, keys = gsea_bnt_m1$ID, columns = "DEFINITION", keytype = "GOID") 
gsea_bnt_m1<-
  gsea_bnt_m1 %>%
  left_join(Annotation.1st,by = c("ID" = "GOID"))%>%
  left_join(Annotation,by = c("secondary_id" = "GOID")) %>%
  distinct(ID,.keep_all = TRUE)
  

gsea_snv_m1<-readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_SNV.rds")@result %>%
  filter(p.adjust<0.05) %>%
  mutate(Direction=case_when(NES>0 ~ "UP",TRUE ~ "DOWN"),
         Group="CoronaVac 1m pv. vs. baseline")%>%
  dplyr::select(ONTOLOGY,ID,Description,ID,Direction,Group,NES,p.adjust) %>%
  filter(ONTOLOGY=="BP") %>%
  merge(final_mapped_hierarchy %>% filter(group=="SNV_M1"),by.x="ID",by.y="raw_id") %>%
  dplyr::select(ID,Description,secondary_id,group,Direction,NES,p.adjust)
Annotation<-AnnotationDbi::select(GO.db, keys = gsea_snv_m1$secondary_id, columns = "TERM", keytype = "GOID") 
Annotation.1st<-AnnotationDbi::select(GO.db, keys = gsea_snv_m1$ID, columns = "DEFINITION", keytype = "GOID") 
gsea_snv_m1<-
  gsea_snv_m1 %>%
  left_join(Annotation.1st,by = c("ID" = "GOID"))%>%
  left_join(Annotation,by = c("secondary_id" = "GOID")) %>%
  distinct(ID,.keep_all = TRUE)

gsea_BNT_M6<-readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_adjust_M6_M0_BNT.rds")@result %>%
  filter(p.adjust<0.05) %>%
  mutate(Direction=case_when(NES>0 ~ "UP",TRUE ~ "DOWN"),
         Group="BNT162b2 6m pv. vs. baseline") %>%
  dplyr::select(ONTOLOGY,ID,Description,ID,Direction,Group,NES,p.adjust) %>%
  filter(ONTOLOGY=="BP") %>%
  merge(final_mapped_hierarchy %>% filter(group=="BNT_M6"),by.x="ID",by.y="raw_id") %>%
  dplyr::select(ID,Description,secondary_id,group,Direction,NES,p.adjust)
Annotation<-AnnotationDbi::select(GO.db, keys = gsea_BNT_M6$secondary_id, columns = "TERM", keytype = "GOID") 
Annotation.1st<-AnnotationDbi::select(GO.db, keys = gsea_BNT_M6$ID, columns = "DEFINITION", keytype = "GOID") 
gsea_BNT_M6<-
  gsea_BNT_M6 %>%
  left_join(Annotation.1st,by = c("ID" = "GOID"))%>%
  left_join(Annotation,by = c("secondary_id" = "GOID")) %>%
  distinct(ID,.keep_all = TRUE)


gsea_SNV_M6<-readRDS("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/GSEA_TIME/V2/goGSEA_ensemble_adjust_M6_M0_SNV.rds")@result %>%
  filter(p.adjust<0.05) %>%
  mutate(Direction=case_when(NES>0 ~ "UP",TRUE ~ "DOWN"),
         Group="CoronaVac 6m pv. vs. baseline") %>%
  dplyr::select(ONTOLOGY,ID,Description,ID,Direction,Group,NES,p.adjust) %>%
  filter(ONTOLOGY=="BP") %>%
  merge(final_mapped_hierarchy %>% filter(group=="SNV_M6"),by.x="ID",by.y="raw_id") %>%
  dplyr::select(ID,Description,secondary_id,group,Direction,NES,p.adjust)
Annotation<-AnnotationDbi::select(GO.db, keys = gsea_SNV_M6$secondary_id, columns = "TERM", keytype = "GOID") 
Annotation.1st<-AnnotationDbi::select(GO.db, keys = gsea_SNV_M6$ID, columns = "DEFINITION", keytype = "GOID") 
gsea_SNV_M6<-
  gsea_SNV_M6 %>%
  left_join(Annotation.1st,by = c("ID" = "GOID"))%>%
  left_join(Annotation,by = c("secondary_id" = "GOID")) %>%
  distinct(ID,.keep_all = TRUE)
gsea_overall_figure2a<-
  gsea_bnt_m1 %>%
  bind_rows( gsea_BNT_M6 ) %>%
  bind_rows( gsea_snv_m1 ) %>%
  bind_rows( gsea_SNV_M6 ) %>%
  mutate(group=factor(group,levels=c("BNT_M1","BNT_M6","SNV_M1","SNV_M6"),labels=c("BNT162b2: Baseline vs. 1m pv.",
                                                                                   "BNT162b2: Baseline vs. 6m pv.",
                                                                                   "CoronaVac: Baseline vs. 1m pv.",
                                                                                   "CoronaVac: Baseline vs. 6m pv.")))
  
# write.xlsx(gsea_overall_figure2a,"~/Projects/Multi_omics/Results/2.2_Pathway_Analysis/Figure2A_Longitudinal_ggsva_pathway_overall.xlsx")
#Select those pathways mapped in both M1 and M6
gsea_term_BNT<-intersect(gsea_bnt_m1$ID,gsea_BNT_M6$ID)
gsea_term_SNV<-intersect(gsea_snv_m1$ID,gsea_SNV_M6$ID)


gsea_overall<-
  #gsea_bnt_m1 %>% filter(ID %in% gsea_term_BNT ) %>%
  # bind_rows( gsea_BNT_M6 %>% filter(ID %in% gsea_term_BNT )) %>%
  # bind_rows( gsea_snv_m1 %>% filter(ID %in% gsea_term_SNV )) %>%
  # bind_rows( gsea_SNV_M6 %>% filter(ID %in% gsea_term_SNV )) %>%
  gsea_bnt_m1 %>%
  bind_rows( gsea_BNT_M6) %>%
  bind_rows( gsea_snv_m1) %>%
  bind_rows( gsea_SNV_M6) %>%
  mutate(group=factor(group,levels=c("BNT_M1","BNT_M6","SNV_M1","SNV_M6"),labels=c("BNT162b2: Baseline vs. 1m pv.",
                                                                                   "BNT162b2: Baseline vs. 6m pv.",
                                                                                   "CoronaVac: Baseline vs. 1m pv.",
                                                                                   "CoronaVac: Baseline vs. 6m pv.")))
names(gsea_overall)
# write.xlsx(gsea_overall,"~/Projects/Multi_omics/Results/2.2_Pathway_Analysis/Longitudinal_ggsva_pathway.xlsx")
# [1] "ID"           "Description"  "secondary_id" "group"        "Direction"    "DEFINITION"   "TERM"    "NES"   p.adjust


shape=c(UP=24,DOWN=25)

ggplot(gsea_overall %>% filter(TERM=="immune system process") , #
       aes(group,Description)) +
  geom_point(aes(fill = NES, size = log10(p.adjust),shape=Direction)) +
  scale_size()+
  scale_shape_manual(values=shape)+
  scale_fill_gradient2(low = "#5281B9", mid = "#FFFDC1", high = "#D73729",
                         midpoint = 0)+
  facet_wrap(~TERM, scales = "free") +
  theme(strip.text.x = element_text(size = 20, color = "red", face = "bold.italic")) +
  theme_minimal() +  # Start with a minimal theme
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border = element_rect(colour = "black", fill = NA, size = 0.5))+
  theme(plot.margin = margin(1, 1, 1, 1, "cm"),
        axis.text.x = element_text(size = 12, angle = 45, vjust = 1, hjust = 1,face="bold"),
        axis.text.y = element_text(size = 12,face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12,face = "bold"),
        legend.spacing.y = unit(0.3, 'cm'),
        legend.key.size = unit(0.3, 'cm'),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),  # Remove minor grid lines
        panel.background = element_rect(fill = "white", colour = NA)) +  # White background
  labs(fill = "NES", size = "−log10(FDR)", shape="Regulation",x = "",y="")

ggsave("~/Projects/Multi_omics/Results/2.2_Pathway_Analysis/Longitudinal_scatter_plot_immune_meta.pdf",width=30,height=25)


ggplot(gsea_overall %>% filter(TERM=="metabolic process"|TERM=="immune system process"|TERM=="multicellular organismal process") , #
       aes(group,Description)) +
  geom_point(aes(fill = NES, size = log10(p.adjust),shape=Direction)) +
  scale_size()+
  scale_shape_manual(values=shape)+
  scale_fill_gradient2(low = "#5281B9", mid = "#FFFDC1", high = "#D73729",
                         midpoint = 0)+
  facet_wrap(~TERM, scales = "free") +
  theme(strip.text.x = element_text(size = 20, color = "red", face = "bold.italic")) +
  theme_minimal() +  # Start with a minimal theme
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border = element_rect(colour = "black", fill = NA, size = 0.5))+
  theme(plot.margin = margin(1, 1, 1, 1, "cm"),
        axis.text.x = element_text(size = 12, angle = 45, vjust = 1, hjust = 1,face="bold"),
        axis.text.y = element_text(size = 12,face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12,face = "bold"),
        legend.spacing.y = unit(0.3, 'cm'),
        legend.key.size = unit(0.3, 'cm'),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),  # Remove minor grid lines
        panel.background = element_rect(fill = "white", colour = NA)) +  # White background
  labs(fill = "NES", size = "−log10(FDR)", shape="Regulation",x = "",y="")

ggsave("~/Projects/Multi_omics/Results/2.2_Pathway_Analysis/Longitudinal_scatter_plot_immune_meta.pdf",width=30,height=25)

ggplot(gsea_overall %>% filter(TERM=="cellular process"), 
       aes(group,Description)) +
  geom_point(aes(fill = NES, size = log10(p.adjust),shape=Direction)) +
  scale_size()+
  scale_shape_manual(values=shape)+
  scale_fill_gradient2(low = "#5281B9", mid = "#FFFDC1", high = "#D73729",
                       midpoint = 0)+
  facet_wrap(vars(TERM), scales = "free",nrow=1) +
  theme_minimal() +  # Start with a minimal theme
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border = element_rect(colour = "black", fill = NA, size = 0.5))+
  theme(strip.text.x = element_text(size = 20, face="bold")) +
  theme(plot.margin = margin(1, 1, 1, 1, "cm"),
        axis.text.x = element_text(size = 12, angle = 45, vjust = 1, hjust = 1,face="bold"),
        axis.text.y = element_text(size = 12,face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12,face = "bold"),
        legend.spacing.y = unit(0.3, 'cm'),
        legend.key.size = unit(0.3, 'cm'),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),  # Remove minor grid lines
        panel.background = element_rect(fill = "white", colour = NA)) +  # White background
  labs(fill = "NES", size = "−log10(FDR)", shape="Regulation",x = "",y="")

ggsave("~/Projects/Multi_omics/Results/2.2_Pathway_Analysis/Longitudinal_scatter_plot_cellular.pdf",width=12,height=40)

Neural_Pathways<-
  read.xlsx("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/3_differential_results/Pathway_analyses/ssGSEA/Annotation_Pathways.xlsx") %>%
  filter(BNT_Neuro==1) %>%
  pull("BNT_Pathways")

gsea_overall$new_description<-gsub(" ","_",gsea_overall$Description)
gsea_overall_neural<-
  gsea_overall %>%
  filter(new_description %in% Neural_Pathways)
dim(gsea_overall_neural)

p2<-ggplot(gsea_overall_neural, #
       aes(group,Description)) +
  geom_point(aes(fill = NES, size = log10(p.adjust),shape=Direction)) +
  scale_size()+
  scale_shape_manual(values=shape)+
  scale_fill_gradient2(low = "#5281B9", mid = "#FFFDC1", high = "#D73729",
                       midpoint = 0)+
  #facet_wrap(~TERM, scales = "free") +
  theme(strip.text.x = element_text(size = 20, color = "red", face = "bold.italic")) +
  theme_minimal() +  # Start with a minimal theme
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border = element_rect(colour = "black", fill = NA, size = 0.5))+
  theme(plot.margin = margin(1, 1, 1, 1, "cm"),
        axis.text.x = element_text(size = 12, angle = 45, vjust = 1, hjust = 1,face="bold"),
        axis.text.y = element_text(size = 12,face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12,face = "bold"),
        legend.spacing.y = unit(0.3, 'cm'),
        legend.key.size = unit(0.3, 'cm'),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),  # Remove minor grid lines
        panel.background = element_rect(fill = "white", colour = NA)) +  # White background
  labs(fill = "NES", size = "−log10(FDR)", shape="Regulation",x = "",y="",title = "Neural function")

p1<-ggplot(gsea_overall %>% filter(TERM=="immune system process") , #
           aes(group,Description)) +
  geom_point(aes(fill = NES, size = log10(p.adjust),shape=Direction)) +
  scale_size()+
  scale_shape_manual(values=shape)+
  scale_fill_gradient2(low = "#5281B9", mid = "#FFFDC1", high = "#D73729",
                       midpoint = 0)+
  facet_wrap(~TERM, scales = "free") +
  theme_minimal() +  # Start with a minimal theme
  theme(#strip.text.x = element_text(size = 20, color = "red", face = "bold.italic"),
    strip.text = element_blank()) +
  
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border = element_rect(colour = "black", fill = NA, size = 0.5))+
  theme(plot.margin = margin(1, 1, 1, 1, "cm"),
        axis.text.x = element_text(size = 12, angle = 45, vjust = 1, hjust = 1,face="bold"),
        axis.text.y = element_text(size = 12,face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12,face = "bold"),
        legend.spacing.y = unit(0.3, 'cm'),
        legend.key.size = unit(0.3, 'cm'),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),  # Remove minor grid lines
        panel.background = element_rect(fill = "white", colour = NA)) +  # White background
  labs(fill = "NES", size = "−log10(FDR)", shape="Regulation",x = "",y="",title = "Immune system process")

ggarrange(p1,p2,common.legend = TRUE,legend = "right")


ggsave("~/Library/CloudStorage/OneDrive-TheChineseUniversityofHongKong/Project/Multi-omics/Results/Result/Figure_V1_20231130/Part2_Longitudinal_changes/Figure2c.pdf",
       width=20,height=12)

```

